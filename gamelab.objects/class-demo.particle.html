<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Particle</title>
    <script src="../dist/gamelab/gamelab.js"></script>
    <script src="./../res/libraries/dat.gui.js"></script>
    <!-- spritebox-example.css style -->
    <link rel="stylesheet" href="../res/styles/gamelab-example.css">

    <style>

      span.dgc-title {
        position: absolute;
        z-index: 9999;
        width: 241px;
        height: 20px;
        font-size: 12px;
        top: 0;
        overflow: visible;
        background: #111;
        color: lightgrey;
        padding-left: 4px;
        border-bottom: 1px solid #444;
      }
    </style>

  </head>
  <body>
    <header>
      <img src="../res/images/gamelab-logo.png" alt="" id="logo">
      <span class="title">Particle</span>
    </header>
    <script>

      var CacheSettings = {
        X: 0,
        Y: 0,
        WIDTH: 250,
        HEIGHT: 250,
        updatesPerFrame: 10,
        maxFrames: 20
      };

      function createController(title) {

        var controller = new dat.GUI();

        var domTitle = document.createElement('span');
        domTitle.classList.add('dgc-title');

        domTitle.innerHTML = title;

        controller.domElement.appendChild(domTitle);
        controller.domElement.style.marginTop = '20px';
        return controller;
      };

      function addCacheControls() {

        var controller = createController('Cache-Frames');

        var X = controller.add(CacheSettings, 'X').min(0).max(2000).step(1),
          Y = controller.add(CacheSettings, 'Y').min(0).max(2000).step(1)

        var WIDTH = controller.add(CacheSettings, 'WIDTH').min(0).max(2000).step(1),
          HEIGHT = controller.add(CacheSettings, 'HEIGHT').min(0).max(2000).step(1)

        var upf = controller.add(CacheSettings, 'updatesPerFrame').min(1).max(20).step(1),
          maxFrames = controller.add(CacheSettings, 'maxFrames').min(1).max(20).step(1);

        var domTitle = document.createElement('span');
        domTitle.classList.add('dgc-title');
        domTitle.innerHTML = 'Cache-Frames';
        controller.domElement.appendChild(domTitle);
        controller.domElement.style.marginTop = '20px';
      };

      /***************
      * Call gameWindow.start()
      * *************/
      var particle,
        gameWindow;

      datargs = {
        sourcelists: {
          a: [],
          b: [],
          c: [],
          d: [],
          e: []
        },
        shape:'circle',
        path: {
          selection: 'random',
          size: {
            x: 200,
            y: 200
          },
          curve: 'linear'
        },
        birthrate: {
          a: 20,
          b: 20,
          transition: 'random'
        },
        life: {
          a: 70,
          b: 70,
          transition: 'random'
        },
        color: {
          a: '#ff0000',
          b: '#0000ff',
          transition: 'linear'
        },
        speed: {
          a: 1.0,
          b: 4.0,
          transition: 'linear'
        },
        scale: {
          a: 0.8,
          b: 0.1,
          transition: 'linear'
        },
        angle: {
          a: -105,
          b: -65,
          transition: 'random'
        },
        alpha: {
          a: 1.0,
          b: 0.1,
          transition: 'linear'
        }
      };

      var ParticleDemo;


      function ready(){

        var ctrls = document.querySelectorAll('.dg.main');

        if(ctrls.length)
        {
          ctrls.forEach(function(item){

              if(item)
              item.remove();

          });
        }

        var controller = createController('set-particle');

        //Create the game-window


        gameWindow = gameWindow || new Gamelab.GameWindow().Background('black');

        gameWindow.reset_draw();

        particle = new Gamelab.Particle(datargs, gameWindow).Src('./res/images/particles/white-ring.png');

        ParticleDemo = {
          particle: particle,
          shoot: function (datargs) {
            this.particle.Position(300, 350);
            this.particle.enter(1)
          }
        };

        var birthrate = controller.addFolder('birthrate');

        birthrate.add(datargs.birthrate, 'a').min(1).max(10).step(1);

        birthrate.add(datargs.birthrate, 'b').min(1).max(10).step(1);

        var keysx = [
            'life',
            'color',
            'speed',
            'scale',
            'angle',
            'alpha'
          ],

          keysy = ['a', 'b', 'transition'];


          controller.addButton = function(text, onUpdate){

            var main_li = document.createElement('li'),
              div1 = document.createElement('div'),

              div2 = document.createElement('div');
            div2.classList.add('c');

            var button = document.createElement('button');

            button.innerText = text;
            button.onclick = onUpdate || function(){};

            div2.appendChild(button);
            div1.appendChild(div2);
            main_li.appendChild(div1);
            var ul = this.domElement.querySelectorAll('ul')[0];
            ul.appendChild(main_li);
            return this;
          };

        controller.addSourceImageMulti = function (object, key, id) {
          var main_li = document.createElement('li'),
            div1 = document.createElement('div');

          var div2 = document.createElement('div');
          div2.classList.add('c');

          var file_input = document.createElement('input');
          file_input.type = 'file';
          file_input.multiple = 'multi';

          div2.appendChild(file_input);
          div1.appendChild(div2);
          main_li.appendChild(div1);
          var ul = this.domElement.querySelectorAll('ul')[0];
          ul.appendChild(main_li);
          return this;
        };

        keysx.forEach(function (kx) {
          var folder = controller.addFolder(kx);

          if (kx == 'color') {

            var colora = folder.addColor(datargs[kx], 'a'),
              colorb = folder.addColor(datargs[kx], 'b');

            var ctrl = folder.add(datargs[kx], 'transition', [
              'random',
              'linear',
              'quadratic',
              'cubic',
              'quintic',
              'quartic'
            ]);

            ctrl.onChange(function (value) {
              ready();
            });

            colora.onFinishChange(function (value) {
              ready();
            });

            colorb.onFinishChange(function (value) {
              ready();
            });

            return;
          }

          keysy.forEach(function (ky) {

            if (!datargs[kx][ky]) {
              return;
            }

            switch (ky) {
              case 'transition':

                var ctrl = folder.add(datargs[kx], ky, [
                  'random',
                  'linear',
                  'quadratic',
                  'cubic',
                  'quintic',
                  'quartic'
                ]);

                break;

              case 'a':
              case 'b':

                var ctrl = folder.add(datargs[kx], ky);

                if (kx == 'life') {
                  ctrl.onChange(function (value) {
                    particle.Life(value, value, 'random');
                  });
                }
                break;

              default:
                var ctrl = folder.add(datargs[kx], ky);
            }
          });
        });

        controller.addButton('Restart', function(){

            alert('clicked');

        });

        //call fxn .addSourceImageMulti()
        controller.addSourceImageMulti(datargs.sources, 'a');
        controller.addSourceImageMulti(datargs.sources, 'b');
        controller.addSourceImageMulti(datargs.sources, 'c');

        var pathFolder = controller.addFolder('paths');

        pathFolder.add(datargs.path, 'curve', ['linear', 'quadratic', 'cubic', 'quartic', 'quintic']);

        var pathSizeFolder = pathFolder.addFolder('path-size');

        pathSizeFolder.add(datargs.path.size, 'x');
        pathSizeFolder.add(datargs.path.size, 'y');

        var COUNT = 0;

        setTimeout(function () {

          gameWindow.onBeforeDraw(function () {

            COUNT += 1;

            if (COUNT % 4 == 0)
              ParticleDemo.shoot();

            }
          );

        }, 1000);

        addCacheControls();

        //start gameWindow
        if(!BEGIN)
        {
          gameWindow.start();
          BEGIN = true;
        }

      };

      var BEGIN = false;

      Gamelab.ready(function () {

      ready();

      });
    </script>

  </body>
</html>
