"use strict";function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function jstr(obj){return JSON.stringify(obj)}function $Q(selector){var $GFunx={};$GFunx.each=function(callback){for(var x=0;x<this.length;x++)"number"==typeof x&&callback(x,this[x])},$GFunx.on=function(evt_key,selectorObject,controller_ix,callback){if("function"==typeof evt_key&&"function"==typeof selectorObject){var boolTrigger=evt_key,boolCall=selectorObject;(new Gamestack.BoolEvent).On(boolTrigger).Call(boolCall)}var criterion=$Q.between("[","]",evt_key);criterion.indexOf("===")>=0&&(criterion=criterion.replace("===","=")),criterion.indexOf("==")>=0&&(criterion=criterion.replace("==","=").replace("==",0));criterion.split("=");evt_key.indexOf("[")>=0&&(evt_key=$Q.before("[",evt_key).trim());var padding=0;controller_ix&&"function"==typeof controller_ix&&!callback&&(callback=controller_ix,controller_ix=0),selectorObject&&"function"==typeof selectorObject&&!callback&&(callback=selectorObject,selectorObject=$Q("*"),controller_ix=0);var evt_profile={};if(evt_profile.cix=controller_ix,evt_profile.evt_key=evt_key,$Q.contains_any(["stick","button","click","key"],evt_profile.evt_key)){evt_profile.evt_key.indexOf("button")>=0;Gamestack.GamepadAdapter.on(evt_profile.evt_key,0,function(x,y){callback(x,y)}),console.info("detected input event key in:"+evt_profile.evt_key),console.info("TODO: rig events")}else if($Q.contains_any(["collide","collision","hit","touch"],evt_profile.evt_key))this.each(function(ix,item1){selectorObject.each(function(iy,item2){if("function"==typeof item1.onUpdate){var update=function(sprite){this.hasBoxCollision(item2,padding)&&callback(this,item2)};item1.onUpdate(update)}})});else{console.info("Rigging a property event"),console.info("detected property threshhold event key in:"+evt_profile.evt_key),console.info("TODO: rig property events");var condition="_",key=criterion||evt_profile.evt_key;(key.indexOf("[")>=0||key.indexOf("]")>=0)&&(key=$Q.between("[","]",key));var evt_parts=[],run=function(){console.error("Sprite property check was not set correctly")};key.indexOf(">=")>=0?condition=">=":key.indexOf("<=")>=0?condition="<=":key.indexOf(">")>=0?condition=">":key.indexOf("<")>=0?condition="<":key.indexOf("=")>=0&&(condition="="),evt_parts=key.split(condition);for(var x=0;x<evt_parts.length;x++)evt_parts[x]=evt_parts[x].replace("=","").replace("=","").trim();var mykey,number;try{mykey=evt_parts[0],number=parseFloat(evt_parts[1])}catch(e){console.log(e)}switch(console.info("Gamestack:Processing condition with:"+condition),condition){case">=":run=function(obj,key){obj[key]>=number&&callback()};break;case"<=":run=function(obj,key){obj[key]<=number&&callback()};break;case">":run=function(obj,key){obj[key]>number&&callback()};break;case"<":run=function(obj,key){obj[key]<number&&callback()};break;case"=":run=function(obj,key){obj[key]==number&&callback()}}var keys=mykey.split("."),propkey="";this.each(function(ix,item){var object={};if(1==keys.length?(object=item,propkey=mykey):2==keys.length?(object=item[keys[0]],propkey=keys[1]):3==keys.length?(object=item[keys[0]][keys[1]],propkey=keys[2]):console.error(":length of '.' notation out of range. We use max length of 3 or prop.prop.key."),"function"==typeof item.onUpdate){item.onUpdate(function(sprite){run(object,propkey)})}})}};var object_out=new Object;if("string"!=typeof selector)"object"!==("undefined"==typeof selector?"undefined":_typeof(selector))&&(selector={}),object_out=selector;else if(selector&&"*"!==selector){var s=selector||"";console.info("selector:"+s);var mainSelector=$Q.before("[",s).trim(),msfChar=mainSelector.substring(0,1),__targetClassName="*",cleanSelectorString=function(str){return str.replace(",","")};switch(msfChar.toLowerCase()){case".":console.info('Selecting by "." or class'),__targetClassName=cleanSelectorString($Q.after(".",mainSelector)),console.info("Target class is:"+__targetClassName);break;case"*":console.info('Selecting by "*" or ANY object in the library instance'),__targetClassName="*"}var criterion=$Q.between("[","]",s),cparts=criterion.split("="),__targetGroup="*",__targetName="*",getParts=function(){if(cparts.length>=2)switch(cparts[0].toLowerCase()){case"name":console.log("Q():Detected parts in selector:"+jstr(cparts)),__targetName=cleanSelectorString(cparts[1]);break;case"group":console.log("Q():Detected parts in selector:"+jstr(cparts)),__targetGroup=cleanSelectorString(cparts[1])}if(cparts.length>=4)switch(cparts[2]=cparts[2].replace(",",""),cparts[2].toLowerCase()){case"name":console.log("Q():Detected parts in selector:"+jstr(cparts)),__targetName=cleanSelectorString(cparts[3]);break;case"group":console.log("Q():Detected parts in selector:"+jstr(cparts)),__targetGroup=cleanSelectorString(cparts[3])}};getParts(cparts),object_out=Gamestack.select(__targetClassName,__targetName,__targetGroup)}else"*"==selector&&(object_out=Gamestack.all_objects);for(var x in $GFunx)object_out[x]=$GFunx[x];return object_out}function CreateGamestack(){return Gamestack}var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},Gamestack={},GamestackLibrary=function(){var lib={settings:{DEBUG:!1,gui_mode:!0,recursionCount:0},defSize:function(){0==this.WIDTH&&(this.WIDTH=document.body.clientWidth),0==this.HEIGHT&&(this.HEIGHT=document.body.clientHeight)},WIDTH:0,HEIGHT:0,game_windows:[],all_objects:[],bool_events:[],__gameWindow:{},spriteTypes:[],systemSpriteTypes:["player","enemy","background","interactive","terrain","weapon","subsprite"],__gameWindowList:[],objectDestroyed:function(obj){var dead=!0;for(var x in this.game_windows){var gw=this.game_windows[x];for(var y in gw.objects)gw.objects[y]===obj&&(dead=!1)}return dead},getObjectById:function(id){for(var x=0;x<this.all_objects.length;x++)if(this.all_objects[x].id==id)return this.all_objects[x]},interlog:function(message,div){this.recursionCount++,!isNaN(div)&&this.settings.recursionCount%div==0},create_id:function(){var S4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()},error:function(quit,message){if(quit)throw new Error(message);console.error("E!"+message)},info:function(m){Gamestack.DEBUG&&console.info("Info:"+m)},log:function(m){Gamestack.DEBUG&&console.log("Gamestack:"+m)},Modifiers:{collideable:function(obj,args){obj.collision_callback=function(){},obj.onCollide=args.onCollide||function(collideables,callback){"function"==typeof collideables&&(callback=collideables),this.collision_callback=callback||function(){}}},spatial:function(obj){obj.Size=function(x,y,z){return"object"==("undefined"==typeof x?"undefined":_typeof(x))?this.size=new Gamestack.Vector(x):isNaN(x)||isNaN(y)?this.size=new Gamestack.Vector(x,x,x):this.size=new Gamestack.Vector(x,y,z),this},obj.Pos=function(x,y,z){return"object"==("undefined"==typeof x?"undefined":_typeof(x))?this.position=new Gamestack.Vector(x):isNaN(x)||isNaN(y)?this.position=new Gamestack.Vector(x,x,x):this.position=new Gamestack.Vector(x,y,z),this},obj.Rot=function(x,y,z){return"object"==("undefined"==typeof x?"undefined":_typeof(x))?this.rotation=new Gamestack.Vector(x):isNaN(x)||isNaN(y)?this.rotation=new Gamestack.Vector(x,x,x):this.rotation=new Gamestack.Vector(x,y,z),this},obj.Position=obj.Pos,obj.Rotate=obj.Rot,obj.Rotation=obj.Rot},posable:function(){obj.Pos=function(x,y,z){return"object"==("undefined"==typeof x?"undefined":_typeof(x))?this.position=new Gamestack.Vector(x):isNaN(x)||isNaN(y)?this.position=new Gamestack.Vector(x,x,x):this.position=new Gamestack.Vector(x,y,z),this},obj.Position=obj.Pos},rotable:function(){obj.Rot=function(x,y,z){return"object"==("undefined"==typeof x?"undefined":_typeof(x))?this.rotation=new Gamestack.Vector(x):isNaN(x)||isNaN(y)?this.rotation=new Gamestack.Vector(x,x,x):this.rotation=new Gamestack.Vector(x,y,z),this},obj.Rotate=obj.Rot,obj.Rotation=obj.Rot},informable:function(obj,args){obj.name=Gamestack.getArg(args,"name","__ObjectName"),obj.description=Gamestack.getArg(args,"description",!1),obj.group=Gamestack.getArg(args,"group","one")},tweenable:function(obj,args){obj.curve_string=args.curve_string||"linearNone",obj.setTweenCurve=function(c){c=c||"linear_none";var cps=c.split("_"),s1=cps[0].toLowerCase(),s2=cps[1].toLowerCase(),curve=TWEEN.Easing.Linear.None;return obj.curve_string="linear_none",Gamestack.each(TWEEN.Easing,function(ix,easing){Gamestack.each(TWEEN.Easing[ix],function(iy,easeType){ix==s1&&iy==s2&&(curve=TWEEN.Easing[ix][iy],obj.curve_string=ix+"_"+iy)})}),obj.curve=curve,curve},obj.curvesToArray=function(){var c=[];return Gamestack.each(TWEEN.Easing,function(ix,easing){Gamestack.each(easing,function(iy,easeType){["in","out","inout","none"].indexOf(iy.toLowerCase())>=0&&c.push(ix+"_"+iy)})}),c}},applyParentalArgs:function(obj,args){return args.parent instanceof Gamestack.Sprite?(alert("parent was Sprite()"),obj.parent=args.parent,obj.parent_id=obj.parent.id):(obj.parent_id=args.parent_id||args.object_id||"__blank",obj.parent=Gamestack.getObjectById(obj.parent_id)),obj.parent}},Collision:{basicBoxCollide:function(pos1,size1,pos2,size2){return pos1.x>=pos2.x-size1.x&&pos1.x<=pos2.x+size2.x&&pos1.y>=pos2.y-size1.y&&pos1.y<=pos2.y+size2.y},spriteRectanglesCollide:function(obj1,obj2,gw){gw=gw||Gamestack.game_windows[0];var camPos=new Gamestack.Vector(0,0,0);obj1.padding=obj1.padding||new Gamestack.Vector(0,0,0);var paddingX=Math.round(obj1.padding.x*obj1.size.x),paddingY=Math.round(obj1.padding.y*obj1.size.y),left=obj1.position.x+paddingX+camPos.x,right=obj1.position.x+obj1.size.x-paddingX+camPos.x,top=obj1.position.y+camPos.y+paddingY,bottom=obj1.position.y+obj1.size.y-paddingY+camPos.y;if(right>obj2.position.x&&left<obj2.position.x+obj2.size.x&&bottom>obj2.position.y&&top<obj2.position.y+obj2.size.y)return!0},pixelsCollide:function(sourceSprite,targetSprite,gw){function hitBox(source,target){return!(source.y+source.height<target.y||source.y>target.y+target.height||source.x+source.width<target.x||source.x>target.x+target.width)}gw=gw||Gamestack.game_windows[0];for(var source=(new Gamestack.Vector(0,0,0),{position:sourceSprite.position,pixelMap:sourceSprite.selected_animation.pixelMap}),target={position:targetSprite.position,pixelMap:targetSprite.selected_animation.pixelMap},s=0;s<source.pixelMap.length;s++)for(var sourcePixel=source.pixelMap[s],sourceArea={x:sourcePixel.x+sourceSprite.position.x,y:sourcePixel.y+sourceSprite.position.y,width:1,height:1},t=0;t<target.pixelMap.length;t++){var targetPixel=target.pixelMap[t],targetArea={x:targetPixel.x+targetSprite.position.x,y:targetPixel.y+targetSprite.position.y,width:1,height:1};if(hitBox(sourceArea,targetArea))return!0}}},_gameWindow:{},setGameWindow:function(gameWindow){this._gameWindow=gameWindow},ExtendEvents:function(extendedObject,extendedKey,extendor,extendorKey){new GSEventLink(extendedObject,extendedKey,extendor,extendorKey);this.all_objects.push(new GSEventLink(extendedObject,extendedKey,extendor,extendorKey));var parent=extendedObject;parent&&(console.log("Gamestack:EXTENDING EVENTS:"+extendedKey+":"+extendorKey),parent.onRun&&parent.onRun(extendor,extendorKey),parent.onComplete&&parent.onComplete(extendor,extendorKey))},removeOffscreenObjects:function(gw){gw=gw||Gamestack.game_windows[0],Gamestack.each(Gamestack.all_objects,function(ix,item){item instanceof Gamestack.Sprite&&0==item.onScreen()&&!item.__keepAlive&&!item.keepAlive&&gw.remove(item)})},removeDeadObjects:function(gw){gw=gw||Gamestack.game_windows[0],Gamestack.each(Gamestack.all_objects,function(ix,item){item instanceof Gamestack.Sprite&&item.isDead()&&gw.remove(item)})},getGameWindow:function(){return this._gameWindow},assignAll:function(object,args,keys){__gamestackInstance.each(keys,function(ix,item){object[ix]=args[ix]})},each:function(list,onResult,onComplete){for(var i in list)onResult(i,list[i]);"function"==typeof onComplete&&onComplete(!1,list)},ready_callstack:[],ready:function(callback){this.ready_callstack.push(callback)},reload:function(){this.callReady()},callReady:function(){var funx=this.ready_callstack,gameWindow=this._gameWindow,lib=this,objects=this.__gameWindow.objects;this.each(funx,function(ix,call){call(lib,gameWindow,objects)}),this.InputSystem.init(),this.__running=!0},getArg:function(args,keys,fallback){"string"==typeof keys&&(keys=[keys]);for(var x=0;x<keys.length;x++){var k=keys[x];if(args&&args.hasOwnProperty(k))return args[k]}return fallback},normalArgs:function(args){function normal(str){return str.toLowerCase().replace("-","").replace(" ","").replace("_","")}var a={};for(var x in args)a[normal(x)]=args[x];return a},isNormalStringMatch:function(str1,str2){return str1.toLowerCase().replace(" ","")==str2.toLowerCase().replace(" ","")},instance_type_pairs:function(){var objectList=[];return this.each(this.all_objects,function(ix,item){objectList.push({constructor_name:item.constructor.name,type:item.type})}),objectList},getById:function(id){for(var x in this.all_objects)if(this.all_objects[x].id==id)return this.all_objects[x]},select:function(constructor_name,name,group){var objects_out=[],__inst=this;return this.each(this.all_objects,function(ix,item){"*"!=constructor_name&&item.constructor.name!=constructor_name||("*"==group||__inst.isNormalStringMatch(group,item.group))&&("*"==name||__inst.isNormalStringMatch(name,item.name))&&objects_out.push(item)}),objects_out}};return lib},GamestackApi={get:function(){},post:function(object){object.id||(object.id=Gamestack.create_id());object.name,object.constructor.name,jstr(object),object.id}},log=function(str){console.log(str)},GSO=function(){function GSO(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,GSO),this.run_ext=args.run_ext||[],this.complete_ext=args.complete_ext||[]}return _createClass(GSO,[{key:"onRun",value:function(caller,callkey){this.run_ext=this.run_ext||[],this.run_ext.indexOf(caller[callkey])==-1&&this.run_ext.push({caller:caller,callkey:callkey})}},{key:"onComplete",value:function(caller,callkey){this.complete_ext=this.complete_ext||[],this.complete_ext.indexOf(caller[callkey])==-1&&this.complete_ext.push({caller:caller,callkey:callkey})}},{key:"call_on_run",value:function(){for(var x=0;x<this.run_ext.length;x++)this.run_ext[x].caller[this.run_ext[x].callkey]()}},{key:"call_on_complete",value:function(){for(var x=0;x<this.complete_ext.length;x++)this.complete_ext[x].caller[this.complete_ext[x].callkey]()}}]),GSO}(),GameImage=function(){function GameImage(src,onCreate){if(_classCallCheck(this,GameImage),!src||src instanceof String&&![".jpg",".png",".gif"].indexOf(src.toLowerCase())>=0)return console.info("Requested an UNDEFINED or Non-Image-File for image src"),{};if(src instanceof Object&&src.src)this.image=document.createElement("IMG"),this.image.src=src.src,this.src=src.src;else if("string"==typeof src){src.substring(src.lastIndexOf("."),src.length);this.image=document.createElement("IMG"),this.image.src=src,this.src=this.image.src}return this.image?(this.image.onerror=function(){this.__error=!0},this.domElement=this.image,void((src.data||src.image&&src.image.data)&&(console.info("GameImage() : found and applied image.data"),this.data=src.data))):(this.image={error:"Image not instantiated, set to object by default"},{})}return _createClass(GameImage,[{key:"getImage",value:function(){return this.image}}]),GameImage}();Gamestack=new GamestackLibrary;var __gamestackInstance=Gamestack;Gamestack.Sound=Sound,Gamestack.GameImage=GameImage,"undefined"!=typeof module&&module.exports&&(module.exports=Gamestack),Gamestack.jstr=jstr,$Q.each=function(obj,callback,complete){for(var x in obj)callback(obj);"function"==typeof complete&&complete(obj)},$Q.before=function(c1,test_str){var start_pos=0,end_pos=test_str.indexOf(c1,start_pos);return test_str.substring(start_pos,end_pos)},$Q.contains=function(c1,test_str){return test_str.indexOf(c1)>=0},$Q.contains_all=function(cList,test_str){for(var x=0;x<cList.length;x++)if(test_str.indexOf(cList[x])<0)return!1;return!0},$Q.contains_any=function(cList,test_str){for(var x=0;x<cList.length;x++)if(test_str.indexOf(cList[x])>=0)return!0;return!1},$Q.after=function(c1,test_str){var start_pos=test_str.indexOf(c1)+1,end_pos=test_str.length;return test_str.substring(start_pos,end_pos)},$Q.between=function(c1,c2,test_str){var start_pos=test_str.indexOf(c1)+1,end_pos=test_str.indexOf(c2,start_pos);return test_str.substring(start_pos,end_pos)},$Q.test_selector_method=function(){for(var Q_TestStrings=["*",".Sprite",'*[group="enemy_type_0"]','.Sprite[group="enemy_type_0"]'],x=0;x<Q_TestStrings.length;x++){var test=Q_TestStrings[x];console.info("testing:"+test),$Q(test)}console.log("Testing stick left"),this.on("stick_left_0"),console.log("Testing button"),this.on("button_0"),console.log("Testing collide"),this.on("collide"),console.log("Testing button"),this.on("collide"),console.log("Testing prop"),this.on("health>=0")},Gamestack.$Q=$Q,Gamestack.query=$Q,Gamestack.InputSystem={events:{mousemove:[],leftclick:{},rightclick:{},middleclick:[],wheelup:[],wheelDown:[]},keymap:{},keyReplace:function(str){return str.toLowerCase().replace("space"," ").replace("left",String.fromCharCode(37)).replace("left",String.fromCharCode(37)).replace("up",String.fromCharCode(38)).replace("right",String.fromCharCode(39)).replace("down",String.fromCharCode(40))},extendKey:function(evt_key,_callback,onFinish){return evt_key=this.keyReplace(evt_key),Gamestack.InputSystem.keymap[evt_key]={down:!1,callback:function(){_callback(evt_key)}},Gamestack.InputSystem.keymap[evt_key]},extend:function(evt_key,downCall,upCall,onFinish){return evt_key=evt_key.toLowerCase(),Gamestack.InputSystem[evt_key]={down:downCall,up:upCall},Gamestack.InputSystem[evt_key]},init:function(){function getMousePos(e,c){var x,y;return e.pageX||e.pageY?(x=e.pageX,y=e.pageY):(x=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,y=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),x-=c.offsetLeft,y-=c.style.top,{x:x,y:y}}function fullMoveInputSystem(event,c){var pos=getMousePos(event,c),InputSystem=Gamestack.InputSystem;for(var x in InputSystem.events)InputSystem.events[x]instanceof Array&&"mousemove"==x&&Gamestack.each(InputSystem.events[x],function(ix,el){el.down(pos.x,pos.y)})}window.setInterval(function(){Gamestack.each(Gamestack.InputSystem.keymap,function(im,kmapItem){1==kmapItem.down&&kmapItem.callback()})},10),document.onkeydown=document.onkeyup=function(e){e=e||event;var gs_key_string="key_"+String.fromCharCode(e.keyCode),evt_object=Gamestack.InputSystem.keymap[gs_key_string]||Gamestack.InputSystem.keymap[gs_key_string.toLowerCase()];evt_object&&(evt_object.down="keydown"==e.type)};for(var canvases=document.getElementsByTagName("CANVAS"),x=0;x<canvases.length;x++){var applyMouseMove=function(e){fullMoveInputSystem(e,c)},c=canvases[x];document.addEventListener("mousemove",applyMouseMove),c.onmousedown=function(e){var pos=(e.which,getMousePos(e,c)),InputSystem=Gamestack.InputSystem;switch(e.preventDefault(),e.which){case 1:for(var x in InputSystem.events)InputSystem.events[x]instanceof Array&&"leftclick"==x&&Gamestack.each(InputSystem.events[x],function(ix,el){el.down(pos.x,pos.y)});break;case 2:for(var x in Gamestack.InputSystem.events)InputSystem.events[x]instanceof Array&&"middleclick"==x&&Gamestack.each(InputSystem.events[x],function(ix,el){el.down(pos.x,pos.y)});break;case 3:for(var x in Gamestack.InputSystem.events)if(InputSystem.events[x]instanceof Array&&"rightclick"==x)return Gamestack.each(InputSystem.events[x],function(ix,el){el.down(pos.x,pos.y)}),!1;break;default:return 0}return e.preventDefault(),0},c.onmouseup=function(e){var pos=(e.which,getMousePos(e,c)),InputSystem=Gamestack.InputSystem;switch(e.preventDefault(),e.which){case 1:for(var x in InputSystem.events)InputSystem.events[x]instanceof Array&&"leftclick"==x&&Gamestack.each(InputSystem.events[x],function(ix,el){el.up(pos.x,pos.y)});break;case 2:for(var x in Gamestack.InputSystem.events)InputSystem.events[x]instanceof Array&&"middleclick"==x&&Gamestack.each(InputSystem.events[x],function(ix,el){el.up(pos.x,pos.y)});break;case 3:for(var x in Gamestack.InputSystem.events)if(InputSystem.events[x]instanceof Array&&"rightclick"==x)return Gamestack.each(InputSystem.events[x],function(ix,el){el.up(pos.x,pos.y)}),!1;break;default:return 0}}}}},window.onload=function(){Gamestack.callReady()},Gamestack.file_system={localizedSource:function(src,hostUrl){hostUrl=hostUrl||"../";var gs_folder_ix=src.indexOf("assets/game");return hostUrl+src.substring(gs_folder_ix,src.length)},loadJSON:function(filepath,callback){$.getJSON(filepath,function(data){callback(!1,data)})},loadJSONLevel:function(filepath,gw,callback){"function"!=typeof gw&&gw||(callback=gw||callback||function(){},gw=Gamestack.game_windows[0]),$.getJSON(filepath,function(data){$.each(data.sprites,function(ix,xitem){"string"==typeof xitem.src&&(xitem.src=Gamestack.file_system.localizedSource(xitem.src)),__gamestackInstance.each(xitem,function(iy,yitem){yitem.src&&(yitem.src=Gamestack.file_system.localizedSource(yitem.src)),__gamestackInstance.each(yitem,function(iz,zitem){zitem.src&&(zitem.src=Gamestack.file_system.localizedSource(zitem.src))})}),xitem=new Gamestack.Sprite(xitem),gw.add(xitem),ix>=data.sprites.length-1&&callback(!1,data)})})}},Gamestack.ready(function(lib){Gamestack.log("Gamestack: library is ready")});var Typo={MakeArray:function(obj){return obj instanceof Array?obj:obj=[obj]},Convert:function(obj,type){return obj instanceof type?obj:obj=[obj]},TypeHalt:function(obj,type){if(obj instanceof type)return obj;throw new Error("object not of required type")},TypeError:function(obj,type){return obj instanceof type?obj:(console.log(new Error("object not of required type")),console.info(obj),console.info(type+"?"),obj)},Restore:function(){},Datify:function(){},Decycle:function(){},Clone:function(){},TagByType:function(){},MergeByType:function(){},MergeByKeys:function(){}};!function(){console.log("Animation class... creating");var Animation=function(){function Animation(){var src=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Animation);var args="object"==("undefined"==typeof src?"undefined":_typeof(src))?src:{};Gamestack.Modifiers.informable(this,args),"string"==typeof src?(console.log("setting GameImage with string:"+src),this.src=src,this.image=new Gamestack.GameImage(src),args.frameBounds||this.setToSingleFrame()):args instanceof GameImage?(console.log("Animation(): args are an instance of GameImage"),this.image=args):args instanceof HTMLImageElement?(console.log("Animation(): args was an instance of HTMLImageElement"),this.image=new Gamestack.GameImage(args)):args instanceof Gamestack.Animation?this.image=args.image:"object"==("undefined"==typeof args?"undefined":_typeof(args))&&args.src&&(this.src=args.src,this.image=new Gamestack.GameImage(args.src)),this.frameSize=this.frameSize||new Gamestack.Vector(args.frameSize||new Gamestack.Vector(0,0)),args.frameBounds&&args.frameBounds.min&&args.frameBounds.max?this.frameBounds=new Gamestack.VectorFrameBounds(args.frameBounds.min,args.frameBounds.max,args.frameBounds.termPoint):this.frameBounds=new Gamestack.VectorFrameBounds(new Gamestack.Vector(0,0,0),new Gamestack.Vector(0,0,0),new Gamestack.Vector(0,0,0)),this.frameOffset=this.getArg(args,"frameOffset",new Gamestack.Vector(0,0,0)),this.apply2DFrames(),this.flipX=this.getArg(args,"flipX",!1),this.cix=0,this.selected_frame=this.frames[0]||!1,this.timer=0,this.duration=args.duration||2e3,this.seesaw_mode=args.seesaw_mode||!1,this.reverse_frames=args.reverse_frames||!1,this.run_ext=args.run_ext||[],this.complete_ext=args.complete_ext||[]}return _createClass(Animation,[{key:"setToSingleFrame",value:function(){var __inst=this;return this.image.domElement.onload=function(){__inst.__isInit||__inst.FrameSize(__inst.image.domElement.width,__inst.image.domElement.height).FrameBounds(new Gamestack.Vector(0,0),new Gamestack.Vector(0,0)),__inst.run()},Gamestack.log("Animation():set single-frame animation"),this}},{key:"onRun",value:function(call){this.run_ext.indexOf(call)==-1&&this.run_ext.push(call)}},{key:"onComplete",value:function(call){this.complete_ext.indexOf(call)==-1&&this.complete_ext.push(call)}},{key:"call_on_run",value:function(){for(var x=0;x<this.run_ext.length;x++)this.run_ext[x](this)}},{key:"call_on_complete",value:function(){for(var x=0;x<this.complete_ext.length;x++)this.complete_ext[x](this)}},{key:"FrameSize",value:function(w,h){return this.frameSize=new Gamestack.Vector(w,h),this.__isInit=!0,this.run(),this}},{key:"FrameBounds",value:function(minVector,maxVector,termVector){return this.frameBounds=new Gamestack.VectorFrameBounds(minVector,maxVector,termVector),this.__isInit=!0,this.run(),this}},{key:"Seesaw",value:function(){return this.seesaw_mode||(this.seesaw_mode=!0),this}},{key:"Duration",value:function(millis){return this.duration=millis,this}},{key:"reverseFrames",value:function(){this.frames.reverse()}},{key:"SingleFrame",value:function(){return this.__frametype="single",this.frameSize=new Gamestack.Vector(this.image.domElement.width,this.image.domElement.height),this.frameBounds=!1,this.selected_frame=(new Gamestack.Frame).Image(this.image).Size(this.frameSize),this.frames=[],this.frames[0]=this.selected_frame,this}},{key:"getArg",value:function(args,key,fallback){return args.hasOwnProperty(key)?args[key]:fallback}},{key:"apply2DFrames",value:function(){this.frames=[];for(var fcount=0,quitLoop=!1,y=this.frameBounds.min.y;y<=this.frameBounds.max.y;y++)for(var _x3=this.frameBounds.min.x;_x3<=this.frameBounds.max.x;_x3++){var framePos={x:_x3*this.frameSize.x+this.frameOffset.x,y:y*this.frameSize.y+this.frameOffset.y},f=(new Gamestack.Frame).Image(this.image).Size(this.frameSize).Position(framePos);if(this.frames.push(f),_x3>=this.frameBounds.termPoint.x&&y>=this.frameBounds.termPoint.y){quitLoop=!0;break}if(fcount+=1,quitLoop)break}if(this.frames[0]=this.selected_frame=this.frames[0]||(new Gamestack.Frame).Image(this.image).Size(this.frameSize),this.seesaw_mode){var frames_reversed=this.frames.slice().reverse();this.frames.pop(),this.frames=this.frames.concat(frames_reversed)}this.reverse_frames&&this.reverseFrames()}},{key:"StashToCanvas",value:function(){return this.testCanvas=document.createElement("CANVAS"),this.testCtx=this.testCanvas.getContext("2d"),this.testCanvas.width=this.image.domElement.width,this.testCanvas.height=this.image.domElement.height,this.testCanvas.style.zIndex="9999",this.testCtx.drawImage(this.image.domElement,0,0),this}},{key:"createColorMap",value:function(unitDimen){function ColoredPixelGrid(image,unitSize,ctx){isNaN(unitSize)&&(unitSize=5);for(var grid=[],x=0;x<image.width;x+=unitSize)for(var y=0;y<image.height;y+=unitSize){var pixel=ctx.getImageData(x,y,1,1);if(0!=pixel.data[3]){var vector=new Gamestack.Vector(x-unitSize/2,y-unitSize/2),gridObject={position:vector,size:new Gamestack.Vector(unitSize,unitSize)};grid.push(gridObject)}}return grid}return this.image&&this.image.domElement?(this.StashToCanvas(),this.colorMap=ColoredPixelGrid(this.image.domElement,unitDimen,this.testCtx),this.colorMap):this}},{key:"getCurrentColorMap",value:function(){var map=[],frame=this.selected_frame;for(var x in this.colorMap){var c=this.colorMap[x];Gamestack.Collision.basicBoxCollide(frame.framePos,frame.frameSize,c.position,c.size)&&map.push(c)}return map}},{key:"setFrame",value:function(ix){this.selected_frame=this.frames[ix]}},{key:"update",value:function(){this.selected_frame=this.frames[Math.round(this.cix)%this.frames.length]}},{key:"reset",value:function(){this.apply2DFrames(),this.cix=0}},{key:"run",value:function(){return"single"==this.__frametype?0:(this.apply2DFrames(),this.update(),void(0==this.cix&&this.engage()))}},{key:"engage",value:function(duration){if(this.call_on_run(),duration=duration||this.duration||20*this.frames.length,"single"==this.__frametype)return 0;var __inst=this;this.tween=new TWEEN.Tween(this).easing(__inst.curve||TWEEN.Easing.Linear.None).to({cix:__inst.frames.length-1},duration).onUpdate(function(){__inst.update()}).onComplete(function(){__inst.cix=0,__inst.call_on_complete(),__inst.isComplete=!0}),this.tween.start()}}]),Animation}();Gamestack.Animation=Animation,Gamestack.Animation.continuous=Gamestack.Animation.run,Gamestack.Animation["continue"]=Gamestack.Animation.run}(),function(){console.log("Camera class... creating");var Camera=function Camera(x,y,z){_classCallCheck(this,Camera),isNaN(x)&&(x=0),isNaN(y)&&(y=0),isNaN(z)&&(z=0),this.position=new Gamestack.Vector(x,y,z)};Gamestack.Camera=Camera}(),function(){console.log("CanvasStack class... creating");var CanvasStack=function CanvasStack(){return _classCallCheck(this,CanvasStack),{__levelMaker:!1,draw:function(sprite,ctx,camera){camera=camera||Gamestack.game_windows[0].camera||{position:new Gamestack.Vector(0,0,0)},sprite.active&&(this.__levelMaker||sprite.onScreen(Gamestack.WIDTH,Gamestack.HEIGHT))&&this.drawPortion(sprite,ctx,camera)},drawFrameWithRotation:function(img,fx,fy,fw,fh,x,y,width,height,deg,canvasContextObj,flipX,flipY){canvasContextObj.save(),deg=Math.round(deg),deg%=360;var rad=deg*Math.PI/180;canvasContextObj.translate(x,y),canvasContextObj.rotate(rad),canvasContextObj.translate(0,canvasContextObj.width),flipX&&canvasContextObj.scale(-1,1),flipY&&canvasContextObj.scale(1,-1),canvasContextObj.drawImage(img,fx,fy,fw,fh,width/2*-1,height/2*-1,width,height),canvasContextObj.restore()},drawData:function(x,y,w,h,data,ctx){ctx.putImageData(data,x,y,0,0,w,h)},drawPortion:function(sprite,ctx,camera){var frame;if(sprite.active){if(!(sprite.selected_animation instanceof Object&&sprite.selected_animation.hasOwnProperty("selected_frame")))return;frame=sprite.selected_animation.selected_frame;var p=sprite.position,camera_pos=camera.position||{x:0,y:0,z:0};sprite.hasOwnProperty("scrollFactor")||(sprite.scrollFactor=1);var x=p.x,y=p.y,scrollFactor=sprite.scrollFactor>=0&&sprite.scrollFactor<=1?sprite.scrollFactor:1;sprite.noScroll&&(scrollFactor=0),x-=camera_pos.x*scrollFactor||0,y-=camera_pos.y*scrollFactor||0;var targetSize=sprite.size||sprite.selected_animation.size,realWidth=targetSize.x,realHeight=targetSize.y;sprite.selected_animation&&sprite.selected_animation.hasOwnProperty("offset")&&(x+=sprite.selected_animation.offset.x,y+=sprite.selected_animation.offset.y);var rotation;rotation="object"==_typeof(sprite.rotation)?sprite.rotation.x:sprite.rotation;var frame=sprite.selected_animation.selected_frame;if(frame&&frame.image&&frame.image.data)ctx.putImageData(frame.image.data,x,y,0,0,sprite.size.x,sprite.size.y);else{
if(!sprite.selected_animation||!sprite.selected_animation.image||!sprite.selected_animation.image.domElement)return;sprite.selected_animation.image.domElement instanceof HTMLImageElement&&this.drawFrameWithRotation(sprite.selected_animation.image.domElement,frame.framePos.x,frame.framePos.y,frame.frameSize.x,frame.frameSize.y,Math.round(x+realWidth/2),Math.round(y+realHeight/2),realWidth,realHeight,rotation%360,ctx,sprite.flipX,sprite.flipY)}}}}};Gamestack.Canvas=new CanvasStack,Gamestack.CanvasStack=CanvasStack}(),function(){console.log("CollisionSettings class... creating");var CollisionSettings=function CollisionSettings(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,CollisionSettings),this.fourway=args.fourway||args.four_way||!1,this.top=this.four_way||args.top||!1,this.bottom=this.four_way||args.bottom||!1,this.left=this.four_way||args.left||!1,this.right=this.four_way||args.right||!1,this.pixel=args.pixel||!1,this.stop=args.stop||!1,this.padding=args.padding||new Gamestack.Vector(0,0,0)};Gamestack.CollisionSettings=CollisionSettings}(),function(){console.log("Force class... creating");var GravityForce=function(){function GravityForce(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,GravityForce),this.name=args.name||"",this.description=args.description||"",this.subjects=args.subjects||[],this.clasticObjects=args.clasticObjects||[],this.topClastics=args.topClastics||[],this.max=args.max||new Vector3(3,3,3),this.accel=args.accel||new Vector3(1.3,1.3,1.3);for(var x in this.clasticObjects)!this.clasticObjects[x]instanceof Gamestack.Sprite&&(this.clasticObjects[x]=Gamestack.getById(this.clasticObjects[x].id));for(var x in this.topClastics)!this.topClastics[x]instanceof Gamestack.Sprite&&(this.topClastics[x]=Gamestack.getById(this.topClastics[x].id));for(var x in this.subjects)!this.subjects[x]instanceof Gamestack.Sprite&&(this.subjects[x]=Gamestack.getById(this.subjects[x].id))}return _createClass(GravityForce,[{key:"getArg",value:function(args,key,fallback){return args.hasOwnProperty(key)?args[key]:fallback}},{key:"update",value:function(){var subjects=this.subjects,clasticObjects=this.clasticObjects,topClastics=this.topClastics,accel=this.accel||{},max=this.max||{};__gameStack.each(subjects,function(ix,itemx){itemx.accelY(accel,max),itemx.__inAir=!0,itemx.position.y>=itemx.groundMaxY&&(itemx.position.y=itemx.groundMaxY),itemx.groundMaxY=3e6,__gameStack.each(clasticObjects,function(iy,itemy){itemx.collide_stop(itemy)}),__gameStack.each(topClastics,function(iy,itemy){itemx.collide_stop_top(itemy)})})}}]),GravityForce}(),Force=GravityForce;Gamestack.Force=Force,Gamestack.GForce=Force,Gamestack.GravityForce=GravityForce}(),function(){console.log("Frame class... creating");var Frame=function(){function Frame(){_classCallCheck(this,Frame);this.framePos=new Gamestack.Vector(0,0)}return _createClass(Frame,[{key:"Image",value:function(i){return this.image=i,this}},{key:"Size",value:function(s){return this.size=new Gamestack.Vector(s,s,s),this.frameSize=new Gamestack.Vector(s,s,s),this}},{key:"Position",value:function(p){return this.position=new Gamestack.Vector(p,p,p),this.framePos=new Gamestack.Vector(p,p,p),this}},{key:"FramePos",value:function(){return this.position=new Gamestack.Vector(p,p,p),this.framePos=new Gamestack.Vector(p,p,p),this}}]),Frame}();Gamestack.Frame=Frame}();var Game=function Game(srcFile){_classCallCheck(this,Game)};Gamestack.Game=Game;var ControllerEventKeys=function ControllerEventKeys(){return _classCallCheck(this,ControllerEventKeys),{left_stick:!1,right_stick:!1,0:!1,1:!1,2:!1,3:!1,4:!1,5:!1,6:!1,7:!1,8:!1,9:!1,10:!1,11:!1,12:!1,13:!1,14:!1,15:!1,16:!1,17:!1,18:!1,19:!1}};Gamestack.ControllerEventKeys=ControllerEventKeys,Gamestack.gamepads=Gamestack.gamepads||[];var GamepadAdapter=function(){function GamepadAdapter(){_classCallCheck(this,GamepadAdapter),this.__gamepads=[],this.intervals=[];var __gamepadMaster=this;this.events=[],window.addEventListener("gamepadconnected",function(e){console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",e.gamepad.index,e.gamepad.id,e.gamepad.buttons.length,e.gamepad.axes.length),__gamepadMaster.mainLoop&&window.clearInterval(__gamepadMaster.mainLoop),__gamepadMaster.mainLoop=window.setInterval(function(){var gps=navigator.getGamepads();__gamepadMaster.gps=gps;for(var x=0;x<gps.length;x++){var events=__gamepadMaster.__gamepads[x]?__gamepadMaster.__gamepads[x]:{};__gamepadMaster.process(__gamepadMaster.gps[x],events)}},20)})}return _createClass(GamepadAdapter,[{key:"gamepads",value:function(){return navigator.getGamepads()}},{key:"disconnect_all",value:function(){for(var x=0;x<this.intervals.length;x++)window.clearInterval(this.intervals[x])}},{key:"disconnect_by_index",value:function(game_pad_index){window.clearInterval(this.intervals[game_pad_index])}},{key:"hasAnyPad",value:function(){return"getGamepads"in navigator}},{key:"Event",value:function(key,game_pad,callback){return{key:key,game_pad:game_pad,callback:callback}}},{key:"GamepadEvents",value:function(args){var gp={};return gp.stick_left=args.stick_left||function(x,y){},gp.stick_right=args.stick_right||function(x,y){},gp.buttons=[],gp.extendFunc=function(f1,f2){return function(x,y){f2(x,y),f1(x,y)}},gp.on=function(key,callback){if(this[key]&&"on"!==key){var current_cb="function"==typeof this[key]?this[key]:function(x,y){};this[key]=this.extendFunc(callback,current_cb)}else if(key.indexOf("button")>=0&&key.indexOf("_")>=0){var number,parts=key.split("_");try{number=parseInt(parts[1]);var current_cb="function"==typeof this.buttons[number]?this.buttons[number]:function(x,y){};this.buttons[number]=this.extendFunc(callback,current_cb)}catch(e){console.error('could not parse "on" event with '+key)}}},gp.constructor={name:"GamepadEvents"},this.__gamepads.push(gp),Gamestack.gamepads=this.__gamepads,gp}},{key:"getGamepads",value:function(){return Gamestack.gamepads}},{key:"process",value:function(gp,gpEvents){this.process_buttons(gp,gpEvents),this.process_axes(gp,gpEvents)}},{key:"process_axes",value:function(gp,events){if(!gp||!gp.axes)return!1;for(var i=0;i<gp.axes.length;i+=2){var ix=(gp.axes[i],gp.axes[i+1],Math.ceil(i/2)+1),x=gp.axes[i],y=gp.axes[i+1];1==ix&&events.stick_left&&events.stick_left(x,y),2==ix&&events.stick_right&&events.stick_right(x,y),this.events&&this.events["stick_"+i]&&"function"==typeof this.events["stick_"+i].callback&&this.events["stick_"+i].callback()}}},{key:"process_buttons",value:function(gp,events){if(!gp||!gp.buttons)return!1;for(var i=0;i<gp.buttons.length&&events.buttons;i++){events.buttons.length>i&&"function"==typeof events.buttons[i]?events.buttons[i](gp.buttons[i].pressed):events.buttons.length>i&&"object"==_typeof(events.buttons[i])&&"function"==typeof events.buttons[i].update&&events.buttons[i].update(events.buttons[i].pressed);var gpc,clearance_1=this.events&&this.events[i],bkey="button_"+i;clearance_1&&(gpc=this.events[bkey]&&!isNaN(this.events[bkey].game_pad)?this.gamepads[this.events[bkey].game_pad]:this.events[bkey].game_pad),clearance_1&&gpc&&"function"==typeof this.events[bkey].callback&&this.events[i].callback()}}},{key:"on",value:function(key,gpix,callback){var keys=Typo.MakeArray(key||[]),gps=Typo.MakeArray(gpix||[]);for(var x in keys)for(var y in gps)gps[y]>=this.__gamepads.length&&this.__gamepads.push(this.GamepadEvents({})),this.__gamepads[y].on(keys[x],callback)}}]),GamepadAdapter}();Gamestack.GamepadAdapter||(Gamestack.GamepadAdapter=new GamepadAdapter),function(){console.log("GameWindow class: creating");var GameWindow=function(){function GameWindow(){var _ref=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},_ref$canvas=_ref.canvas,canvas=void 0!==_ref$canvas&&_ref$canvas,objects=_ref.objects,update=_ref.update;_ref.camera;_classCallCheck(this,GameWindow),this.objects=objects||[],this.bool_events=Gamestack.bool_events||[],this.canvas=canvas||!1,canvas||(console.info("GameWindow() had no {canvas:canvas} argument. Creating a new canvas in document.body..."),this.canvas=document.createElement("CANVAS"),this.canvas.setAttribute("class","gamewindow"),document.body.append(this.canvas)),document.body.style.position="absolute",document.body.style.width="100%",document.body.style.height="100%",this.camera=new Gamestack.Camera,this.camera.target=!1,__gamestackInstance.camera=this.camera,"function"==typeof update&&this.onUpdate(update);var __inst=this;this.Size(),this.update_ext=[],window.onresize=function(){__inst.isAbsoluteSize||__inst.Size()},this.ctx=this.canvas.getContext("2d"),Gamestack.game_windows.push(this)}return _createClass(GameWindow,[{key:"uniques",value:function(list){var listout=[];return $Q.each(list,function(ix,item){if(!listout.indexOf(item.id)>=0){item.name;listout.push({sprite:item})}}),listout}},{key:"setPlayer",value:function(player){this.player=player,!this.objects.indexOf(player)>=0&&this.objects.push(player)}},{key:"onUpdate",value:function(f){this.update_ext.push(f)}},{key:"update",value:function(){Gamestack.each(this.objects,function(ix,item){item&&"function"==typeof item.def_update&&item.def_update(item),item&&"function"==typeof item.update&&item.update(item)}),Gamestack.each(this.bool_events,function(ix,item){item&&item.bool()&&item.callback()});for(var x in this.update_ext)this.update_ext[x]()}},{key:"draw",value:function(){var _gw=this;this.before_draw_ext&&this.before_draw_ext(),Gamestack.each(this.objects,function(ix,item){(["Sprite","Background","Interactive","Terrain"].indexOf(item.constructor.name)>=0||item.__isDrawable)&&Gamestack.Canvas.draw(item,_gw.ctx)}),this.draw_ext&&this.draw_ext()}},{key:"onDraw",value:function(f){this.draw_ext=function(){f()}}},{key:"onBeforeDraw",value:function(f){this.before_draw_ext=function(){f()}}},{key:"Size",value:function(w,h,isAbsoluteSize){w=w||this.canvas.parentNode.clientWidth,h=h||this.canvas.parentNode.clientHeight;var c=document.getElementById("#gs-container");return c&&c.setAttribute("width",w),c&&c.setAttribute("height",h),__gamestackInstance.WIDTH=w,__gamestackInstance.HEIGHT=h,this.canvas.width=w,this.canvas.height=h,this.isAbsoluteSize=isAbsoluteSize||!1,this}},{key:"add",value:function(obj,onBottom){if(obj instanceof Gamestack.Camera)this.camera=obj;else if(obj instanceof Gamestack.GSEvent){if(__gamestackInstance.__running)return console.error("Events can only be added before Gamstack.animate() is called::aka before the main update / loop begins");obj.apply()}else onBottom?this.objects.splice(0,0,obj):this.objects.push(obj);return this.collect(obj),obj}},{key:"Background",value:function(c){return this.canvas.style.background=c,this.canvas.style.backgroundColor=c,this}},{key:"remove",value:function(obj){var ix=this.objects.indexOf(obj);ix>=0&&this.objects.splice(ix,1);var ixG=Gamestack.all_objects.indexOf(obj);ixG>=0&&Gamestack.all_objects.splice(ixG,1)}},{key:"collect",value:function(obj){Gamestack.all_objects.push(obj)}},{key:"animate",value:function(time){var __inst=this;requestAnimationFrame(function(){__inst.animate()}),Gamestack.__stats&&(Gamestack.__stats.begin(),Gamestack.__statsMS.begin(),Gamestack.__statsMB.update()),__gamestackInstance.isAtPlay=!0,window.TWEEN&&TWEEN.update(time),__inst.update(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.draw(),Gamestack.__stats&&(Gamestack.__stats.end(),Gamestack.__statsMS.end())}},{key:"start",value:function(){"function"==typeof Stats&&(Gamestack.__stats=new Stats,Gamestack.__stats.showPanel(0),Gamestack.__stats.dom.style.left="30%",Gamestack.__stats.dom.setAttribute("class","stat"),this.canvas.parentNode.appendChild(Gamestack.__stats.dom),Gamestack.__statsMS=new Stats,Gamestack.__statsMS.showPanel(1),Gamestack.__statsMS.dom.style.left="30%",Gamestack.__statsMS.dom.style.marginLeft="90px",Gamestack.__statsMS.dom.setAttribute("class","stat"),this.canvas.parentNode.appendChild(Gamestack.__statsMS.dom),Gamestack.__statsMB=new Stats,Gamestack.__statsMB.showPanel(2),Gamestack.__statsMB.dom.style.left="30%",Gamestack.__statsMB.dom.setAttribute("class","stat"),Gamestack.__statsMB.dom.style.marginLeft="180px",this.canvas.parentNode.appendChild(Gamestack.__statsMB.dom)),this.animate()}}]),GameWindow}();Gamestack.GameWindow=GameWindow}(),function(){function GSEventLink(extendedObject,extendedKey,extendor,extendorKey){this.parent_id=extendedObject.id,this.child_id=extendor.id,this.parent_key=extendedKey,this.child_key=extendorKey}console.log("GSEvent class... creating");var GSEvent=function GSEvent(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,GSEvent),Gamestack.Modifiers.informable(this,args)},InputEvent=function(_GSEvent){function InputEvent(args){_classCallCheck(this,InputEvent);var _this=_possibleConstructorReturn(this,(InputEvent.__proto__||Object.getPrototypeOf(InputEvent)).call(this,args)),btnix=args.btnix||args.button_ix||!1,gpix=args.gpix||args.gamepad_ix||0,callback=args.callback||function(){},six=args.stickix||args.six||args.stick_ix||!1,inputKey=six!==!1?"stick_"+six:btnix!==!1&&"button_"+btnix,keyboardKeys=Typo.MakeArray(args.keys||[]);return keyboardKeys instanceof Array&&Gamestack.each(keyboardKeys,function(ix,keyitem){Gamestack.InputSystem.extendKey("key_"+keyitem.toLowerCase(),function(){callback(keyitem.toLowerCase())})}),inputKey&&gpix>=0&&Gamestack.GamepadAdapter.on(inputKey,gpix,function(x,y){callback(x,y)}),_this}return _inherits(InputEvent,_GSEvent),InputEvent}(GSEvent),KeyboardEvent=function(_InputEvent){function KeyboardEvent(){var keys=arguments.length>0&&void 0!==arguments[0]?arguments[0]:keys instanceof Array?keys:[keys],callback=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};_classCallCheck(this,KeyboardEvent);var _this2=_possibleConstructorReturn(this,(KeyboardEvent.__proto__||Object.getPrototypeOf(KeyboardEvent)).call(this,{}));return _this2.keys=keys,_this2.callback=callback,_this2}return _inherits(KeyboardEvent,_InputEvent),_createClass(KeyboardEvent,[{key:"init",value:function(){var keyboardKeys=this.keys,__inst=this;keyboardKeys instanceof Array&&Gamestack.each(keyboardKeys,function(ix,keyitem){Gamestack.InputSystem.extendKey("key_"+keyitem.toLowerCase(),function(){__inst.callback(keyitem.toLowerCase())})})}},{key:"Keys",value:function(){var keys=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return this.keys=Typo.MakeArray(keys),this}},{key:"Call",value:function(){var callback=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){};return this.callback=callback,this.init(),this}}]),KeyboardEvent}(InputEvent),GamepadEvent=function(_InputEvent2){function GamepadEvent(){var keys=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],callback=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};_classCallCheck(this,GamepadEvent);var _this3=_possibleConstructorReturn(this,(GamepadEvent.__proto__||Object.getPrototypeOf(GamepadEvent)).call(this,{}));return _this3.keys=keys,_this3.callback=callback,_this3}return _inherits(GamepadEvent,_InputEvent2),_createClass(GamepadEvent,[{key:"Gamepads",value:function(){var gps=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return this.gps=gps=Typo.MakeArray(gps||[]),this}},{key:"init",value:function(){var gamepadKeys=Typo.MakeArray(this.keys||[]),__inst=this;Gamestack.GamepadAdapter.on(gamepadKeys,this.gps,function(x,y){__inst.callback(x,y)})}},{key:"Keys",value:function(){var keys=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return this.keys=Typo.MakeArray(keys),this}},{key:"Call",value:function(){var callback=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){};return this.callback=callback,this.init(),this}}]),GamepadEvent}(InputEvent),CollisionEvent=function(_GSEvent2){function CollisionEvent(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return _classCallCheck(this,CollisionEvent),_possibleConstructorReturn(this,(CollisionEvent.__proto__||Object.getPrototypeOf(CollisionEvent)).call(this,args))}return _inherits(CollisionEvent,_GSEvent2),_createClass(CollisionEvent,[{key:"OnCollision",value:function(objects,siblings){return this.objects=Typo.MakeArray(objects||this.objects||[]),this.siblings=Typo.MakeArray(siblings||this.siblings||[]),this}},{key:"Call",value:function(callbackFunction){this.callback=callbackFunction||this.callback||function(){};var __inst=this;return $Q(this.objects).on("collide",$Q(this.siblings),function(obj1,obj2){__inst.callback(obj1,obj2)}),this}}]),CollisionEvent}(GSEvent),BoolEvent=function(_GSEvent3){function BoolEvent(onBool,callback){_classCallCheck(this,BoolEvent);var _this5=_possibleConstructorReturn(this,(BoolEvent.__proto__||Object.getPrototypeOf(BoolEvent)).call(this,{}));return _this5.bool=onBool||function(){console.info("CustomBoolEvent():needs .on function(){}. --Add this as 1st argument or via chainable On() function returning bool argument")},_this5.callback=callback||function(){console.info("CustomBoolEvent():needs .callback function(){} --Add this as 2nd argument or via chainable Call() function")},Gamestack.bool_events.push(_this5),_this5}return _inherits(BoolEvent,_GSEvent3),_createClass(BoolEvent,[{key:"On",value:function(boolFunction){return this.bool=boolFunction,this}},{key:"Call",value:function(callbackFunction){return this.callback=callbackFunction||this.callback||function(){},this}}]),BoolEvent}(GSEvent);BoolEvent.Bool=BoolEvent.On,Gamestack.GSEvent=GSEvent,Gamestack.GSEventLink=GSEventLink,Gamestack.InputEvent=InputEvent,Gamestack.GamepadEvent=GamepadEvent,Gamestack.KeyboardEvent=KeyboardEvent,Gamestack.CollisionEvent=CollisionEvent,Gamestack.BoxCollisionEvent=CollisionEvent,Gamestack.BoolEvent=BoolEvent}(),function(){console.log("CanvasStack class... creating");var GSProton=function(){function GSProton(image,canvas,parent,collideables){_classCallCheck(this,GSProton);var args={image:image,canvas:canvas,parent:parent,collideables:collideables};image.image&&image.canvas&&(args=image),args.canvas=args.canvas||Gamestack.canvas,args.parent=args.parent||new Gamestack.Vector(0,0,0),args.image=args.image||new Gamestack.GameImage,this.name=args.name||"__NO-Name",this.description=args.description||"__NO-Description",this.image=args.image,this.active=!1,this.image=args.image,this.canvas=args.canvas,this.emission_amount_min=1,this.emission_amount_max=1,this.radius=0,this.mass=1,this.emissions_frequency=5,this.gravity=0,this.proton={},this.usingAttraction=!1,this.usingRepulsion=!1,this.usingPointZone=!1,this.pointZoneX=0,this.pointZoneY=0,this.usingBlendAlpha=!1,this.attraction={position:new Vector(0,0),min:0,max:0},this.repulsion={position:new Gamestack.Vector(0,0),min:0,max:0},this.startAlpha=1,this.endAlpha=1,this.startColor_asRandom=!0,this.startColor="#FFFFFF",this.startScale=1,this.endScale=1,this.endColor_asRandom=!0,this.endColor="#FFFFFF",this.positionX_asRandom=!1,this.positionY_asRandom=!1,this.positionX=0,this.positionY=0,this.vSpeedMin=.5,this.vSpeedMax=1.5,this.vSpeedRotationMin=0,this.vSpeedRotationMax=360,this.lifeMin=5,this.lifeMax=10;for(var x in this)args.hasOwnProperty(x)&&(this[x]=args[x]);this.initializers=[],this.behaviors=[]}return _createClass(GSProton,[{key:"replaceBehaviorByType",value:function(constructor,replacement){for(var x in this.behaviors)this.behaviors[x]instanceof constructor&&this.behaviors.splice(x,1);this.behaviors.push(replacement),this.ticker=0}},{key:"Collideables",value:function(collideableArray){this.collideables=collideableArray}},{key:"Rotation",value:function(minRot,maxRot){maxRot=maxRot||minRot,this.vSpeedRotationMin=minRot,this.vSpeedRotationMax=maxRot,this.replaceBehaviorByType(Proton.V,new Proton.V(new Proton.Span(this.vSpeedMin,this.vSpeedMax),new Proton.Span(this.vSpeedRotationMin,this.vSpeedRotationMax),"polar"))}},{key:"Gravity",value:function(grav){this.gravity=grav,this.replaceBehaviorByType(Proton.Gravity,new Proton.Gravity(this.gravity))}},{key:"Velocity",value:function(minV,maxV){maxV=maxV||minV,this.vSpeedMin=minV,this.vSpeedMax=maxV,this.replaceBehaviorByType(Proton.V,new Proton.V(new Proton.Span(this.vSpeedMin,this.vSpeedMax),new Proton.Span(this.vSpeedRotationMin,this.vSpeedRotationMax),"polar"))}},{key:"Attraction",value:function(position,min,max){this.usingAttraction=!0,this.attraction.position=position,this.attraction.min=min,this.attraction.max=max}},{key:"Repulsion",value:function(x,y,min,max){this.usingRepulsion=!0,this.repulsion.position=position,this.repulsion.min=min,this.repulsion.max=max}},{key:"onUpdate",value:function(){}},{key:"isRectangularCollision",value:function(obj1,obj2){return obj1.position.x+obj1.size.x>obj2.position.x&&obj1.position.y+obj1.size.y>obj2.position.y&&obj1.position.x<obj2.position.x+obj2.size.x&&obj1.position.y<obj2.position.y+obj2.size.y}},{key:"collide",value:function(obj1,obj2){console.log("collide() function UNSET")}},{key:"update",value:function(collideables){collideables=collideables||this.collideables||[],this.ticker+=1,this.ticker%100==0&&(console.log("Proton:update():"),console.log(this.emitter)),this.positionX_asRandom?this.emitter.p.x=Math.floor(Math.random()*canvas.width):this.emitter.p.x=this.positionX,this.positionY_asRandom?this.emitter.p.y=Math.floor(Math.random()*canvas.width):this.emitter.p.y=this.positionY;for(var particles=this.emitter.particles,x=0;x<particles.length;x++)for(var p={size:{x:Math.round(this.emitter.initializes[0].w*this.emitter.scale),y:Math.round(this.emitter.initializes[0].h*this.emitter.scale)},position:particles[x].p},y=0;y<collideables.length;y++)collideables[y].hasOwnProperty("position")&&collideables[y].hasOwnProperty("size")&&this.isRectangularCollision(p,collideables[y])&&this.collide(p,collideables[y])}},{key:"init",value:function(){function allNumbers(list){for(var x in list)if("number"!=typeof list[x])return!1;return!0}this.proton=new Proton,this.emit_mode=this.emit_mode||"",this.emitter=new Proton.Emitter,this.emission_amount=this.emission_amount||10,this.emissions_frequency=this.emissions_frequency||10;var rps=5/this.emissions_frequency;this.emitter.rate=new Proton.Rate([this.emission_amount_min,this.emission_amount_max],rps),this.initializers=[],this.behaviors=[],this.initializers.push(new Proton.ImageTarget(this.image)),this.initializers.push(new Proton.Mass(this.mass)),this.initializers.push(new Proton.Life(this.lifeMin,this.lifeMax)),this.initializers.push(new Proton.V(new Proton.Span(this.vSpeedMin,this.vSpeedMax),new Proton.Span(this.vSpeedRotationMin,this.vSpeedRotationMax),"polar")),this.usingPointZone&&this.initializers.push(new Proton.Position(new Proton.PointZone(this.pointZoneX,this.pointZoneY))),this.behaviors.push(new Proton.Gravity(this.gravity)),this.behaviors.push(new Proton.Alpha(1,[this.startAlpha,this.endAlpha])),this.behaviors.push(new Proton.Color(this.startColor_asRandom?"random":this.startColor,this.endColor_asRandom?"random":this.endColor,1/0,Proton.easeInSine)),this.behaviors.push(new Proton.Scale(this.startScale,this.endScale)),allNumbers([this.attractionX,this.attractionY,this.attractionMin,this.attractionMax])&&(console.info("Creating attraction"),this.behaviors.push(new Proton.Attraction({x:this.attractionX,y:this.attractionY},this.attractionMin,this.attractionMax))),allNumbers([this.repulsionX,this.repulsionY,this.repulsionMin,this.repulsionMax])&&(console.info("Creating repulsion"),this.behaviors.push(new Proton.Repulsion({x:this.repulsionX,y:this.repulsionY},this.repulsionMin,this.repulsionMax))),this.usingAttraction&&this.behaviors.push(new Proton.Attraction(this.attraction.position,this.attraction.min,this.attraction.max)),this.usingRepulsion&&this.behaviors.push(new Proton.Repulsion(this.repulsion.position,this.repulsion.min,this.repulsion.max)),this.radius>0&&this.initializers.push(new Proton.Radius(this.radius));var i=this.initializers;for(var x in i)this.emitter.addInitialize(i[x]);var b=this.behaviors;for(var x in b)this.emitter.addBehaviour(b[x]);this.emitter.p=this.parent&&this.parent.hasOwnProperty("x")?new Vector(this.parent):this.emitter.p,this.emitter.p=this.parent&&this.parent.hasOwnProperty("position")&&this.parent.position.hasOwnProperty("x")?new Vector(this.parent.position):this.emitter.p,this.emitter.p.x+=this.positionX,this.emitter.p.y+=this.positionY,this.emitter.emit(),this.proton.addEmitter(this.emitter),this.renderer=new Proton.Renderer("canvas",this.proton,this.canvas),this.usingBlendAlpha&&this.renderer.blendFunc("SRC_ALPHA","ONE");this.renderer.start(),this.tick()}},{key:"on",value:function(){this.init()}},{key:"off",value:function(){this.emitter&&this.emitter.stopEmit&&this.emitter.stopEmit()}},{key:"tick",value:function(){requestAnimationFrame(function(){__inst.tick()});var __inst=this;this.proton.update()}}]),GSProton}();Gamestack.GSProton=GSProton}();var head=document.head||document.getElementsByTagName("head")[0];head.innerHTML+='<style>\r\n.speech-triangle { overflow:visible; }.speech-triangle:before { content: "";position: absolute;z-index:-1;width: 0;height: 0;left: 38px;bottom: -18px;border-width: 8px 8px;border-style: solid;border-color: #fff transparent transparent #fff; } .farLeft:after{ right:0px; left:20px; } .farRight:after{ left:0px; right:20px; }   .flipX:after{  -moz-transform: scaleX(-1); -webkit-transform: scaleX(-1); -o-transform: scaleX(-1); transform: scaleX(-1); -ms-filter: fliph; /*IE*/ filter: fliph; /*IE*/  }  </style>',function(){console.log("HtmlExtra classes... creating");var HtmlExtra=function(){function HtmlExtra(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,HtmlExtra),this.applyCSSArgs(args)}return _createClass(HtmlExtra,[{key:"applyCSSArgs",value:function(args){var norms=Gamestack.normalArgs(args);this.widthFloat=Gamestack.getArg(norms,["width","widthfloat","w"],.5),this.heightFloat=Gamestack.getArg(norms,["height","heightfloat","h"],.5),this.topFloat=Gamestack.getArg(norms,["top","topfloat","t"],.5),this.bottomFloat=Gamestack.getArg(norms,["bottom","bottomfloat","b"],!1),this.color=norms.color||"#ffffff",this.backgroundColor=Gamestack.getArg(norms,["backgroundcolor","backcolor","background","bc"],"black"),this.text=norms.text||"__BLANK",this.fontFamily=norms.font||norms.fontFamily||"appFont",this.border="2px inset "+this.color,this.fontSize=norms.fontsize||"20px",this.bottomFloat>=0?this.targetBottom=this.get_float_pixels(this.bottomFloat,document.body.clientHeight):this.targetTop=this.get_float_pixels(this.topFloat,document.body.clientHeight),this.fadeTime={"in":200,out:200}}},{key:"Opacity",value:function(o){return this.domElement.style.opacity=o,this}},{key:"Top",value:function(v){return this.targetTop=this.get_float_pixels(v,document.body.clientHeight),this.domElement.style.bottom="auto",this.domElement.style.top=this.targetTop,this}},{key:"Left",value:function(v){return this.targetLeft=this.get_float_pixels(v,document.body.clientWidth),this.domElement.style.right="auto",this.domElement.style.left=this.targetLeft,this}},{key:"Bottom",value:function(v){return this.targetBottom=this.get_float_pixels(v,document.body.clientHeight),this.domElement.style.top="auto",this.domElement.style.bottom=this.targetBottom,this}},{key:"Right",value:function(v){return this.targetRight=this.get_float_pixels(v,document.body.clientWidth),this.domElement.style.left="auto",this.domElement.style.right=this.targetRight,this}},{key:"FontSize",value:function(v){return v.indexOf("px")==-1&&v.indexOf("em")==-1&&v.indexOf("%")==-1&&(v+="px"),this.domElement.style.fontSize=v,this}},{key:"FontFamily",value:function(v){return this.domElement.style.fontFamily=v,this}},{key:"Text",value:function(v){return this.domElement.innerText=v,this}},{key:"Background",value:function(v){return this.domElement.style.background=v,this}},{key:"Duration",value:function(d){return this.duration=d,this}},{key:"FadeTime",value:function(fadeInTime,fadeOutTime){return this.fadeTime={"in":fadeInTime||250,out:fadeOutTime||250},this}},{key:"Color",value:function(c){return this.domElement.style.color=c,this}},{key:"TextColor",value:function(c){return this.domElement.style.color=c,this}},{key:"Border",value:function(b){this.domElement.style.border=b}},{key:"get_float_pixels",value:function(float,dimen){return Math.round(dimen*float)+"px"}},{key:"onComplete",value:function(fun){return this.complete=fun,this}},{key:"show",value:function(text,duration){document.body.append(this.domElement);var __inst=this;return this.show_interval&&clearInterval(this.show_interval),this.show_interval=setInterval(function(){var o=parseFloat(__inst.domElement.style.opacity);o<1&&(o+=1*(20/__inst.fadeTime["in"]),__inst.domElement.style.opacity=o)},20),setTimeout(function(){clearInterval(__inst.show_interval),__inst.hide_interval=setInterval(function(){var o=parseFloat(__inst.domElement.style.opacity);o>0?(o-=1*(20/__inst.fadeTime.out),__inst.domElement.style.opacity=o):(__inst.domElement.style.opacity=o,"function"==typeof __inst.complete&&__inst.complete(),clearInterval(__inst.hide_interval))},20)},__inst.duration),this}},{key:"update",value:function(){}}]),HtmlExtra}(),TextDisplay=function(_HtmlExtra){function TextDisplay(){var textDisplayArg=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,TextDisplay);var args=textDisplayArg,_this6=_possibleConstructorReturn(this,(TextDisplay.__proto__||Object.getPrototypeOf(TextDisplay)).call(this,args));return args||(args={}),_this6.duration=args.duration||5e3,_this6.complete=args.complete||function(){},_this6.create_dom(),_this6}return _inherits(TextDisplay,_HtmlExtra),_createClass(TextDisplay,[{key:"create_dom",value:function(){this.domElement=document.createElement("SPAN"),this.domElement.style.position="fixed",this.domElement.style.color=this.color,this.domElement.style.padding="5px",this.targetBottom?this.domElement.style.bottom=Math.round(document.body.clientHeight*this.bottomFloat)+"px":this.domElement.style.top=Math.round(document.body.clientHeight*this.topFloat)+"px",this.targetRight?this.domElement.style.right=Math.round(document.body.clientWidth*this.rightFloat)+"px":this.domElement.style.left=Math.round(document.body.clientWidth*this.leftFloat)+"px",this.domElement.style.width="90%",this.domElement.style.left="5%",this.domElement.style.height="auto",this.domElement.style.fontFamily=this.fontFamily,this.domElement.style.fontSize=this.fontSize,this.domElement.style.display="block",this.domElement.style.textAlign="center",this.domElement.style.zIndex="9999",this.domElement.innerText=this.text,this.domElement.textContent=this.text,this.domElement.style.backgroundColor="transparent",this.domElement.style.opacity=this.fadeIn?0:1,this.domElement.id=Gamestack.create_id()}}]),TextDisplay}(HtmlExtra);Gamestack.TextDisplay=TextDisplay;var ImageStatDisplay=function(_HtmlExtra2){function ImageStatDisplay(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,ImageStatDisplay);var _this7=_possibleConstructorReturn(this,(ImageStatDisplay.__proto__||Object.getPrototypeOf(ImageStatDisplay)).call(this,args));return _this7.src=args.src||"__NONE",_this7.size=args.size||new Gamestack.Vector(50,50),_this7.text_id=Gamestack.create_id(),_this7.id=Gamestack.create_id(),_this7.img_id=Gamestack.create_id(),_this7.create_dom(),_this7}return _inherits(ImageStatDisplay,_HtmlExtra2),_createClass(ImageStatDisplay,[{key:"Src",value:function(src){return this.src=src,this.img.setAttribute("src",src),this}},{key:"Source",value:function(src){return this.src=src,this.img.setAttribute("src",src),this}},{key:"Text",value:function(t){var el=this.span;return el.innerHTML=t,el.textContent=t,this}},{key:"TextMarginTop",value:function(v){v+="",v.indexOf("px")==-1&&v.indexOf("em")==-1&&v.indexOf("%")==-1&&(v+="px");var el=this.span;return el.style.marginTop=v,this}},{key:"Size",value:function(x,y){return this.size=new Gamestack.Vector(x,y||x),this.img.style.width=this.size.x+"px",this.img.style.height="auto",this}},{key:"FontSize",value:function(v){
return v+="",v.indexOf("px")==-1&&v.indexOf("em")==-1&&v.indexOf("%")==-1&&(v+="px"),this.pixelFontSize=v,this.domElement.style.fontSize=v,this}},{key:"FontFamily",value:function(v){return this.domElement.style.fontFamily=v,this}},{key:"setValue",value:function(value){return document.getElementById(this.text_id),this}},{key:"get_float_pixels",value:function(float,dimen){return Math.round(dimen*float)+"px"}},{key:"get_id",value:function(){return this.id}},{key:"update",value:function(v){var e=document.getElementById(this.text_id);return this.text=v+"",e.innerText=this.text,this}},{key:"create_dom",value:function(){return this.domElement=document.createElement("DIV"),this.domElement.style.position="fixed",this.domElement.setAttribute("class","gameStack-stats"),this.img=document.createElement("IMG"),this.img.id=this.img_id,this.img.src=this.src,this.img.style.width=this.size.x+"px",this.img.style.height="auto",this.domElement.append(this.img),this.span=document.createElement("SPAN"),this.span.id=this.text_id,this.span.style.padding="2px",this.span.style["float"]="right",this.span.style.height=this.size.y+"px",this.span.style.display="table-cell",this.span.style.verticalAlign="middle",this.span.style.fontSize="inherit",this.span.textContent=this.text,this.domElement.append(this.span),this.domElement.style.color=this.color,this.domElement.style.fontFamily=this.fontFamily,this.domElement.style.fontSize=this.fontSize,this.domElement.style.zIndex="9999",this.domElement.id=this.id,this}},{key:"show",value:function(x,y){return this.domElement.style.left=x+"px",this.domElement.style.top=y+"px",document.body.append(this.domElement),this}}]),ImageStatDisplay}(HtmlExtra);Gamestack.ImageStatDisplay=ImageStatDisplay;var Bar=function(_HtmlExtra3){function Bar(background,border){_classCallCheck(this,Bar);var _this8=_possibleConstructorReturn(this,(Bar.__proto__||Object.getPrototypeOf(Bar)).call(this,{}));_this8.background=background;var e=document.createElement("SPAN");return e.style.position="fixed",e.style.background=_this8.background,e.style.zIndex="9999",e.style.backgroundSize="100% 100%",e.style.backgroundPosition="center bottom",border&&(e.style.border=border),_this8.domElement=e,_this8}return _inherits(Bar,_HtmlExtra3),_createClass(Bar,[{key:"width",value:function(w){return this.domElement.style.width=w,this}},{key:"height",value:function(h){return this.domElement.style.height=h,this}}]),Bar}(HtmlExtra);Gamestack.Bar=Bar;var BarFill=function(_HtmlExtra4){function BarFill(background){_classCallCheck(this,BarFill);var _this9=_possibleConstructorReturn(this,(BarFill.__proto__||Object.getPrototypeOf(BarFill)).call(this,{}));_this9.background=background;var e=document.createElement("SPAN");return e.style.background=_this9.background,e.style.position="fixed",e.style.zIndex="9995",_this9.domElement=e,_this9}return _inherits(BarFill,_HtmlExtra4),_createClass(BarFill,[{key:"width",value:function(w){return this.domElement.style.width=w,this}},{key:"height",value:function(h){return this.domElement.style.height=h,this}}]),BarFill}(HtmlExtra);Gamestack.BarFill=BarFill;var BarDisplay=function(_HtmlExtra5){function BarDisplay(){var barDisplayArgs=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,BarDisplay);var args=barDisplayArgs||{},_this10=_possibleConstructorReturn(this,(BarDisplay.__proto__||Object.getPrototypeOf(BarDisplay)).call(this,args));return _this10.border=args.border||"none",_this10.inner=args.src||args.inner||"darkorange",_this10.outer=args.outer_src||args.outer||"transparent",_this10.width=args.width+""||args.fill_width+"",_this10.width.indexOf("px")==-1&&(_this10.width+="px"),_this10.height=args.height+""||args.fill_height+"",_this10.height.indexOf("px")==-1&&(_this10.height+="px"),_this10.color=args.color||args.fill_color,Gamestack.defSize(),_this10.CreateDom(),_this10}return _inherits(BarDisplay,_HtmlExtra5),_createClass(BarDisplay,[{key:"Top",value:function(v){this.targetTop=this.get_float_pixels(v,document.body.clientHeight);for(var x in[this.innerDom,this.outerDom])[this.innerDom,this.outerDom][x].Top(v);return this}},{key:"Left",value:function(v){this.targetLeft=this.get_float_pixels(v,document.body.clientWidth);for(var x in[this.innerDom,this.outerDom])[this.innerDom,this.outerDom][x].Left(v);return this}},{key:"Bottom",value:function(v){this.targetBottom=this.get_float_pixels(v,document.body.clientHeight);for(var x in[this.innerDom,this.outerDom])[this.innerDom,this.outerDom][x].Bottom(v);return this}},{key:"Right",value:function(v){this.targetRight=this.get_float_pixels(v,document.body.clientWidth);for(var x in[this.innerDom,this.outerDom])[this.innerDom,this.outerDom][x].Right(v);return this}},{key:"CreateDom",value:function(){this.innerDom=new BarFill(this.inner).width(this.width||"80px").height(this.height||"10px"),this.fill=this.innerDom,this.outerDom=new Bar(this.outer,this.border).width(this.width||"80px").height(this.height||"10px"),this.bar=this.outerDom}},{key:"Inner",value:function(color_or_src){return this.inner=color_or_src,this.CreateDom(),this}},{key:"Outer",value:function(color_or_src){return this.outer=color_or_src,this.CreateDom(),this}},{key:"Border",value:function(css_border){return this.border=css_border,this.CreateDom(),this}},{key:"show",value:function(){return document.body.append(this.innerDom.domElement),document.body.append(this.outerDom.domElement),this}},{key:"Show",value:function(){return document.body.append(this.innerDom.domElement),document.body.append(this.outerDom.domElement),this}},{key:"Width",value:function(w){return this.portion_width(w),this}},{key:"Height",value:function(h){return this.portion_height(h),this}},{key:"get_float_pixels",value:function(float,dimen){return Math.round(dimen*float)+"px"}},{key:"portion_top",value:function(v){this.fill.domElement.style.top=this.get_float_pixels(v||this.topFloat,Gamestack.HEIGHT),this.bar.domElement.style.top=this.get_float_pixels(v||this.topFloat,Gamestack.HEIGHT)}},{key:"portion_left",value:function(v){this.fill.domElement.style.left=this.get_float_pixels(v||this.leftFloat,Gamestack.WIDTH),this.bar.domElement.style.left=this.get_float_pixels(v||this.leftFloat,Gamestack.WIDTH)}},{key:"portion_width",value:function(w){this.fill.domElement.style.width=this.get_float_pixels(w||this.widthFloat,Gamestack.WIDTH),this.bar.domElement.style.width=this.get_float_pixels(w||this.widthFloat,Gamestack.WIDTH)}},{key:"portion_height",value:function(h){this.fill.domElement.style.height=this.get_float_pixels(h||this.heightFloat,Gamestack.HEIGHT),this.bar.domElement.style.height=this.get_float_pixels(h||this.heightFloat,Gamestack.HEIGHT)}},{key:"update",value:function(f){this.fill.domElement.style.width=this.get_float_pixels(f||0,parseFloat(this.bar.domElement.style.width))}}]),BarDisplay}(HtmlExtra);Gamestack.BarDisplay=BarDisplay;var TextBubble=function(_HtmlExtra6){function TextBubble(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,TextBubble);var _this11=_possibleConstructorReturn(this,(TextBubble.__proto__||Object.getPrototypeOf(TextBubble)).call(this,args));return _this11.opacity=args.opacity||.85,_this11.create_dom(),_this11.duration=args.stay||args.duration||100*_this11.text.length,_this11}return _inherits(TextBubble,_HtmlExtra6),_createClass(TextBubble,[{key:"create_dom",value:function(){this.domElement=document.createElement("SPAN"),this.domElement.setAttribute("class","speech-triangle"),this.domElement.style.textAlign="left",this.domElement.style.opacity=this.opacity,this.domElement.style.position="fixed",this.domElement.style.color=this.color||"white","transparent"==this.backgroundColor&&(this.backgroundColor="black"),this.domElement.style.backgroundColor=this.backgroundColor||"black",this.domElement.style.borderRadius="0.4em",this.domElement.style.border=this.border||"1px outset snow",this.domElement.style.borderColor=this.borderColor||"snow",this.domElement.style.padding="5px",this.domElement.style.paddingBottom="2px",this.domElement.style.height="auto",this.domElement.style.top=Math.round(document.body.clientHeight*this.topFloat)+"px",this.domElement.style.left=Math.round(document.body.clientWidth*this.leftFloat)+"px",this.domElement.style.width="auto",this.domElement.style.height="auto",this.domElement.style.fontFamily=this.fontFamily,this.domElement.style.fontSize=this.fontSize,this.domElement.style.display="block",this.domElement.style.textAlign="center",this.domElement.style.zIndex="9999",this.domElement.innerText=this.text,this.domElement.textContent=this.text,this.domElement.style.opacity=this.fadeIn?0:this.opacity,this.domElement.id=Gamestack.create_id()}}]),TextBubble}(HtmlExtra);Gamestack.TextBubble=TextBubble}();var Level=function(){function Level(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Level),this.sprites=args.sprites||[],this.backgrounds=args.backgrounds||[],this.terrains=args.terrains||[],this.interactives=args.interactives||[],this.threes=args.threes||[]}return _createClass(Level,[{key:"add",value:function(){}},{key:"add_all_to_game",value:function(){}}]),Level}();!function(){console.log("Line() class... creating");var Curves={linearNone:function(t){return t},easeInQuadratic:function(t){return t*t},easeOutQuadratic:function(t){return t*(2-t)},easeInOutQuadratic:function(t){return t<.5?2*t*t:-1+(4-2*t)*t},easeInCubic:function(t){return t*t*t},easeOutCubic:function(t){return--t*t*t+1},easeInOutCubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},easeInQuartic:function(t){return t*t*t*t},easeOutQuartic:function(t){return 1- --t*t*t*t},easeInOutQuartic:function(t){return t<.5?8*t*t*t*t:1-8*--t*t*t*t},easeInQuintic:function(t){return t*t*t*t*t},easeOutQuintic:function(t){return 1+--t*t*t*t*t},easeInOutQuintic:function(t){return t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t}};Gamestack.Curves=Curves;var inOutCurves={quadratic:function(t){return t<.5?2*t*t:-1+(4-2*t)*t},cubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},quartic:function(t){return t<.5?8*t*t*t*t:1-8*--t*t*t*t},quintic:function(t){return t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t},linear:function(t){return t}};Gamestack.Curves.InOut=inOutCurves;var Line=function(){function Line(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Line),this.points=[],this.pointDisp=1,this.size=args.size||new Gamestack.Vector(100,100,0),this.position=new Gamestack.Vector(0,0,0)}return _createClass(Line,[{key:"Rot",value:function(r){return this.rotation=r,this}},{key:"Pos",value:function(p){return this.position=p,"number"==typeof p?this.position=new Gamestack.Vector(p,p,p):this.position=p,this}},{key:"Size",value:function(s){return this.size=s,"number"==typeof s&&(this.size=new Gamestack.Vector(s,s,s)),this}},{key:"Dispersion",value:function(num){return this.pointDisp=num,this}},{key:"Curve",value:function(c,size){return this.curve=c,this.curveMethod=Gamestack.Curves.InOut[this.curve.toLowerCase()],c&&(this.curve_size=new Gamestack.Vector(size)),this}},{key:"CurveSize",value:function(s){return"number"==typeof s?this.curve_size=new Gamestack.Vector(s,s,s):this.curve_size=s,this}},{key:"Duration",value:function(d){return this.duration=d,this}},{key:"Fill",value:function(){for(var current_point=new Gamestack.Vector(0,0,0),x=0;x<=Math.abs(this.size.x);x++){var position=new Gamestack.Vector(x,0,0);current_point.trig_distance_xy(position)>=this.pointDisp&&(this.points.push(new Gamestack.Vector(position)),current_point=new Gamestack.Vector(position))}return this.TransposeByRotation(this.rotation),this}},{key:"TransposeByRotation",value:function(rotation){function rotate(cx,cy,x,y,angle){var radians=Math.PI/180*angle,cos=Math.cos(radians),sin=Math.sin(radians),nx=cos*(x-cx)+sin*(y-cy)+cx,ny=cos*(y-cy)-sin*(x-cx)+cy;return new Gamestack.Vector(nx,ny)}this.rotation=rotation;for(var x=0;x<this.points.length;x++){var p=this.points[x],np=rotate(this.position.x,this.position.y,p.x,p.y,this.rotation);this.points[x]=np}return this}},{key:"Highlight",value:function(sprite,ctx,gameWindow){this.highlight_sprites=this.highlight_sprites||[],ctx=ctx||Gamestack.ctx;var points=this.points;gameWindow=gameWindow||Gamestack.game_windows[0];for(var x in points){console.log(points[x]),this.highlight_sprites[x]||(this.highlight_sprites[x]=gameWindow.add(new Gamestack.Sprite(sprite),ctx));var point=points[x];this.highlight_sprites[x].position=new Gamestack.Vector(point.sub(sprite.size.div(2)))}return this}},{key:"RemoveHighlight",value:function(sprite,ctx,gameWindow){gameWindow=gameWindow||Gamestack.game_windows[0];for(var x in this.highlight_sprites)gameWindow.remove(this.highlight_sprites[x]);return this.highlight_sprites=[],this}}]),Line}();Gamestack.Line=Line;var WaveLine=function(_Line){function WaveLine(pos,size,curve_key){_classCallCheck(this,WaveLine);var args={};if("number"==typeof size||size instanceof Gamestack.Vector)var _this12=_possibleConstructorReturn(this,(WaveLine.__proto__||Object.getPrototypeOf(WaveLine)).call(this,{}));else if(size instanceof Object){var _this12=_possibleConstructorReturn(this,(WaveLine.__proto__||Object.getPrototypeOf(WaveLine)).call(this,size));args=size}return _this12.Pos(pos),_this12.Size(size),_this12.curve_options=Curves,curve_key=curve_key||args.curve_key||"quadratic",_this12.curve=curve_key?curve_key.toLowerCase():"quadratic",_this12.curve_options=["cubic","quartic","quadratic","quintic","sine"],_this12.curveMethod=Gamestack.Curves.InOut[_this12.curve.toLowerCase()],_this12.points=args.points||[],_this12.is_highlighted=args.is_highlighted||!1,_this12.offset=args.offset||new Gamestack.Vector(0,0,0),_this12.pointDisp=args.pointDisp||5,_this12.rotation=args.rotation||0,_this12.iterations=args.iterations||1,_this12.max_size=args.max_size||_this12.size||new Gamestack.Vector(5e3,5e3),_this12.growth=args.growth||1,_possibleConstructorReturn(_this12)}return _inherits(WaveLine,_Line),_createClass(WaveLine,[{key:"Max",value:function(p){return this.target=p,"number"==typeof p?this.target=new Gamestack.Vector(p,p,p):this.target=p,this.max=this.target,this}},{key:"Min",value:function(p){return this.position=p,"number"==typeof p?this.position=new Gamestack.Vector(p,p,p):this.tposition=p,this.min=this.position,this}},{key:"Decay",value:function(n){return n<-1&&(n=-1),n>1&&(n=1),this.growth=1-n,this}},{key:"next",value:function(position){for(var found=!1,x=0;x<this.points.length;x++){if(position.equals(this.points[x])&&x<this.points.length-1)return found=!0,new Gamestack.Vector(this.points[x+1]);if(x==this.points.length-1&&!found)return new Gamestack.Vector(this.points[0])}}},{key:"getGraphCanvas",value:function(curveCall,existing_canvas){var canvas=existing_canvas||document.createElement("canvas");canvas.style.position="relative",canvas.id="curve-display",canvas.setAttribute("class","motion-curve"),canvas.width=180,canvas.height=100,canvas.style.background="black";var context=canvas.getContext("2d");context.fillStyle="rgb(0,0,0)",context.fillRect(0,0,180,100),context.lineWidth=.5,context.strokeStyle="rgb(230,230,230)",context.beginPath(),context.moveTo(0,20),context.lineTo(180,20),context.moveTo(0,80),context.lineTo(180,80),context.closePath(),context.stroke(),context.lineWidth=2,context.strokeStyle="rgb(255,127,127)";var position={x:0,y:80},position_old={x:0,y:80};this.test_graph_size=new Gamestack.Vector(185,60);var points=this.get_line_segment(this.test_graph_size,5,curveCall);for(var x in points){var position=new Gamestack.Vector(points[x].x,this.test_graph_size.y+20-points[x].y);context.beginPath(),context.moveTo(position_old.x,position_old.y),context.lineTo(position.x,position.y),context.closePath(),context.stroke(),position_old.x=position.x,position_old.y=position.y}return canvas}},{key:"Fill",value:function(){this.size=new Gamestack.Vector(this.size);this.points=[];for(var current_point=new Gamestack.Vector(this.position),x=1,max_recursion=300,position=current_point,dist=new Gamestack.Vector(20,20,20),size=new Gamestack.Vector(this.curve_size||this.size);Math.abs(position.x)<=Math.abs(this.max_size.x)&&size.x>2&&dist.x>2;){position=new Gamestack.Vector(current_point);var target=new Gamestack.Vector(position.add(size)),start=new Gamestack.Vector(position),curveMethod=this.curveMethod;new Gamestack.Vector(start);for(position.x=position.x;position.x<Math.abs(target.x);position.x+=1){dist=position.sub(start);var pct=dist.x/size.x;if(position.y=start.y+curveMethod(pct)*(x%2==0?size.y:size.y*-1),current_point.trig_distance_xy(position)>=this.pointDisp){var p=new Gamestack.Vector(position);this.points.push(p),current_point=new Gamestack.Vector(position)}}if(size=size.mult(this.growth),x>max_recursion)return console.error("Too much recursion in SwagLine");x+=1}return this.TransposeByRotation(this.rotation),this}},{key:"Rotate",value:function(rotation){return this.rotation=rotation,"object"==_typeof(this.rotation)&&(this.rotation=this.rotation.x),this}}]),WaveLine}(Line);Gamestack.WaveLine=WaveLine;var ShapeLine=function(_Line2){function ShapeLine(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,ShapeLine);var _this13=_possibleConstructorReturn(this,(ShapeLine.__proto__||Object.getPrototypeOf(ShapeLine)).call(this,args));return _this13.targetTotalPoints=args.total||200,_this13}return _inherits(ShapeLine,_Line2),_createClass(ShapeLine,[{key:"Total",value:function(t){return this.targetTotalPoints=t,this}},{key:"Eliptical",value:function(pos,size,rotation){function fill(elipse){elipse.points=[];for(var center=elipse.position.add(elipse.size.div(2)),current_point=new Gamestack.Vector(0,0,0),a=Math.abs(elipse.size.x/2),b=Math.abs(elipse.size.y/2),step=(2*Math.PI*Math.sqrt(a*a+b*b),Math.round(2*Math.PI/elipse.targetTotalPoints*1e3)/1e3),i=0*Math.PI;i<2*Math.PI;i+=step){var p=new Gamestack.Vector(Math.round(center.x-a*Math.cos(i)),Math.round(center.y+b*Math.sin(i)));elipse.points.push(new Gamestack.Vector(p)),current_point=new Gamestack.Vector(p)}}return this.Pos(pos||this.position),this.Size(size||this.size),this.Rot(rotation||this.rotation),fill(this),this.Fill=function(){return fill(this),this},this}},{key:"Quadrilateral",value:function(pos,size,rotation){function fill(quad){quad.points=[];for(var perim=(new Gamestack.Vector(0,0,0),2*quad.size.x+2*quad.size.y),stepX=quad.size.x/(quad.targetTotalPoints*(quad.size.x/perim)),stepY=quad.size.y/(quad.targetTotalPoints*(quad.size.y/perim)),x=0;x<quad.size.x;x+=stepX){var p1=new Gamestack.Vector(x,0).add(quad.position);quad.points.push(new Gamestack.Vector(p1))}for(var y=0;y<quad.size.y;y+=stepY){var p1=new Gamestack.Vector(quad.size.x,y).add(quad.position);quad.points.push(new Gamestack.Vector(p1))}for(var x=quad.size.x;x>=0;x-=stepX){var p1=new Gamestack.Vector(x,quad.size.y).add(quad.position);quad.points.push(new Gamestack.Vector(p1))}for(var y=quad.size.y;y>=0;y-=stepY){var p1=new Gamestack.Vector(0,y).add(quad.position);quad.points.push(new Gamestack.Vector(p1))}}return this.Pos(pos||this.position),this.Size(size||this.size),this.Rot(rotation||this.rotation),fill(this),this.Fill=function(){return fill(this),this},this}}]),ShapeLine}(Line);Gamestack.ShapeLine=ShapeLine}(),function(){console.log("Motion class... creating");var Motion=function(_GSO){function Motion(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Motion);var _this14=_possibleConstructorReturn(this,(Motion.__proto__||Object.getPrototypeOf(Motion)).call(this,args));return _this14.state_save=!1,_this14.parent=args.parent||Gamestack.Modifiers.applyParentalArgs(_this14,args),Gamestack.Modifiers.informable(_this14,args),Gamestack.Modifiers.tweenable(_this14,args),_this14}return _inherits(Motion,_GSO),_createClass(Motion,[{key:"restoreState",value:function(){for(var x in this.state_save)this.parent[x]=this.state_save[x]}}]),Motion}(GSO);Gamestack.Motion=Motion;var TweenMotion=function(_Motion){function TweenMotion(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,TweenMotion);var _this15=_possibleConstructorReturn(this,(TweenMotion.__proto__||Object.getPrototypeOf(TweenMotion)).call(this,args));return _this15.getArg=$Q.getArg,_this15.transition=args.trans||args.transition||"literal"||"add",_this15.transition_options=["literal","add"],"string"==typeof args.curve&&(args.curve_string=args.curve),_this15.setTweenCurve(args.curve_string),_this15.target=!1,_this15.target=args.target||{},_this15.curvesList=_this15.curvesToArray(),_this15.duration=Gamestack.getArg(args,"duration",500),_this15.delay=Gamestack.getArg(args,"delay",0),_this15}return _inherits(TweenMotion,_Motion),_createClass(TweenMotion,[{key:"targetCheck",value:function(parent){this.target.position||(this.target.position=new Gamestack.Vector),this.target.size||(this.target.size=new Gamestack.Vector),this.target.rotation||(this.target.rotation=new Gamestack.Vector)}},{key:"AddPos",value:function(x,y){return this.transition="add",this.target.position=new Gamestack.Vector(x,y),this}},{key:"Duration",value:function(d){return this.duration=d,this}},{key:"engage",value:function(){var __inst=this;__inst.call_on_run(),this.tweens=[];var object=this.parent;this.targetCheck(),this.state_save||(this.state_save={position:new Gamestack.Vector(this.parent.position),rotation:new Gamestack.Vector(this.parent.rotation),size:new Gamestack.Vector(this.parent.size)}),this.parent&&!this.target?this.target={position:new Gamestack.Vector(this.parent.position),rotation:new Gamestack.Vector(this.parent.rotation),size:new Gamestack.Vector(this.parent.size)}:this.target||(this.target={position:new Gamestack.Vector,rotation:new Gamestack.Vector,size:new Gamestack.Vector}),"literal"!==this.transition&&(this.target.position=object.position.add(this.target.position),this.target.rotation=object.rotation.add(this.target.rotation),this.target.size=object.size.add(this.target.size)),this.tweens.push(new TWEEN.Tween(object.position).easing(__inst.curve||__inst.motion_curve).to(this.target.position,__inst.duration).onUpdate(function(){}).onComplete(function(){__inst.complete&&__inst.call_on_complete()})),this.tweens.push(new TWEEN.Tween(object.rotation).easing(__inst.curve||__inst.motion_curve).to(this.target.rotation,__inst.duration).onUpdate(function(){}).onComplete(function(){__inst.complete&&__inst.call_on_complete()})),this.tweens.push(new TWEEN.Tween(object.size).easing(__inst.curve||__inst.motion_curve).to(this.target.size,__inst.duration).onUpdate(function(){}).onComplete(function(){__inst.complete&&__inst.call_on_complete()}));for(var x=0;x<this.tweens.length;x++)this.tweens[x].start()}},{key:"start",value:function(){this.engage()}},{key:"getGraphCanvas",value:function(t,f,c){var canvas=c||document.createElement("canvas");canvas.style.position="relative",canvas.id="curve-display",canvas.setAttribute("class","motion-curve"),canvas.width=180,canvas.height=100,canvas.style.background="black";var context=canvas.getContext("2d");context.fillStyle="rgb(0,0,0)",context.fillRect(0,0,180,100),context.lineWidth=.5,context.strokeStyle="rgb(230,230,230)",context.beginPath(),context.moveTo(0,20),context.lineTo(180,20),context.moveTo(0,80),context.lineTo(180,80),context.closePath(),context.stroke(),context.lineWidth=2,context.strokeStyle="rgb(255,127,127)";var position={x:5,y:80},position_old={x:5,y:80};return new TWEEN.Tween(position).to({x:175},2e3).easing(TWEEN.Easing.Linear.None).start(),new TWEEN.Tween(position).to({y:20},2e3).easing(f).onUpdate(function(){context.beginPath(),context.moveTo(position_old.x,position_old.y),context.lineTo(position.x,position.y),context.closePath(),context.stroke(),position_old.x=position.x,position_old.y=position.y}).start(),canvas}},{key:"getTweenPoints",value:function(size,line){var points=(line.curve,line.duration,[]),position=new Vector(line.position);new Vector(position).add(size),new Vector(position),new Vector(0,0,0);return points}}]),TweenMotion}(Motion);Gamestack.TweenMotion=TweenMotion;var LineMotion=function(_Motion2){function LineMotion(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,LineMotion);var _this16=_possibleConstructorReturn(this,(LineMotion.__proto__||Object.getPrototypeOf(LineMotion)).call(this,args));return Gamestack.Modifiers.spatial(_this16),_this16.total=args.total||20,_this16.Size(args.size||new Gamestack.Vector(200,200)),_this16.Pos(args.size||new Gamestack.Vector(200,200)),_this16.Rot(args.size||new Gamestack.Vector(200,200)),_this16}return _inherits(LineMotion,_Motion2),_createClass(LineMotion,[{key:"Total",value:function(t){return this.total=t,this}},{key:"Highlight",value:function(spr,ctx,gameWindow){return this.line.Highlight(spr,ctx,gameWindow),this}},{key:"Eliptical",value:function(pos,size){return size=size||this.size,pos=pos||this.position,this.line=(new Gamestack.ShapeLine).Total(this.total||20).Eliptical(pos,size,0).Fill(),this}},{key:"Box",value:function(pos,size){return size=size||this.size,pos=pos||this.position,this.line=(new Gamestack.ShapeLine).Total(this.total||20).Quadrilateral(pos,size,0).Fill(),this}},{key:"QuadraticWave",value:function(pos,size){return size=size||this.size,pos=pos||this.position,this.line=new Gamestack.WaveLine(pos,size,"quadratic").Fill(),this}},{key:"CubicWave",value:function(pos,size){return size=size||this.size,pos=pos||this.position,this.line=new Gamestack.WaveLine(pos,size,"cubic").Fill(),this}},{key:"QuinticWave",value:function(pos,size){return size=size||this.size,pos=pos||this.position,this.line=new Gamestack.WaveLine(pos,size,"quintic").Fill(),this}}]),LineMotion}(Motion);Gamestack.LineMotion=LineMotion}();var Projectile=function(){function Projectile(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Projectile),this.getArg=$Q.getArg;for(var x in args)this[x]=args[x];this.name=args.name||"__",this.description=args.description||"__",this.animation=Gamestack.getArg(args,"animation",new Animation),this.parent_id=args.parent_id||args.object_id||"__blank",this.name=Gamestack.getArg(args,"name","__"),this.size=!1,args.size?this.size=new Vector(args.size):this.animation&&this.animation.frameSize?this.size=new Vector(this.animation.frameSize):(console.info("Projectile():using default size."),this.size=new Vector(20,20,20)),this.origin=args.origin||new Vector(0,0,0),this.rotation=args.rotation||0,this.line.Rotation(this.rotation),this.description=Gamestack.getArg(args,"description",!1),this.duration=Gamestack.getArg(args,"duration",500),this.delay=Gamestack.getArg(args,"delay",0),this.position=Gamestack.getArg(args,"position",new Vector(0,0,0)),this.motion_curve=Gamestack.getArg(args,"motion_curve",TWEEN.Easing.Linear.None),this.highlighted=!1,this.sprites=[],this.run_ext=args.run_ext||[]}return _createClass(Projectile,[{key:"onComplete",value:function(fun){this.complete=fun}},{key:"onCollide",value:function(fun){this.collide=fun}},{key:"setAnimation",value:function(anime){return this.animation=anime,this}},{key:"setMotionCurve",value:function(c){return this.motion_curve=c,this}},{key:"kill_one",value:function(){var spr=this.sprites[this.sprites.length-1];Gamestack.remove(spr)}},{key:"onRun",value:function(caller,callkey){this.run_ext=this.run_ext||[],this.run_ext.push({caller:caller,callkey:callkey})}},{key:"shoot_basic",value:function(position,size,rot_offset,speed,numberShots,disp){for(var bx=position.x,by=position.y,half=(size.x,size.y,numberShots/2),x=half*-1;x<=half;x++){var shot=Gamestack.add(new Sprite({active:!0,position:position,size:size,speed:speed,image:animation.image,rotation:new Vector3(0,0,0),flipX:!1}));shot.setAnimation(animation),rot_offset=new Vector(rot_offset+x*disp,0,0),shot.position.x=bx,shot.position.y=by,shot.rotation.x=0+rot_offset.x,shot.stats={damage:1},options.line||shot.onUpdate(function(){shot.position.x+=Math.cos(3.14*shot.rotation.x/180)*speed,shot.position.y+=Math.sin(3.14*shot.rotation.x/180)*speed})}}},{key:"fire",value:function(origin,rotation){for(var x=0;x<this.run_ext.length;x++)this.run_ext[x].caller[this.run_ext[x].callkey]();this.line.origin=origin,this.line.rotation=rotation,console.log("FIRING FROM:"+jstr(origin));var sprite=new Sprite({image:this.animation.image});sprite.setAnimation(this.animation),sprite.setSize(this.size),sprite.position=new Vector(0,0,0);var __inst=this;__inst.line.fill();var lp=this.line.points;sprite.position=new Vector(lp[0]),sprite.onUpdate(function(sprite){for(var x=0;x<lp.length;x++){if(sprite.position.equals(lp[x])&&x<lp.length-1){sprite.position=new Vector(lp[x+1]);break}x==lp.length-1&&Gamestack.remove(sprite)}}),Gamestack.add(sprite),this.sprites.push(sprite)}}]),Projectile}();Gamestack.Projectile=Projectile;var Shapes={circle:function(radius,freq){return{radius:radius,points:[],fill:function(center,freq){}}},square:function(s,freq){return console.error("STILL NEED TO BUILD THIS SQUARE IN GS-API"),{size:new Gamestack.Vector(s,s),width:w,height:h,freq:freq,points:[],fill:function(start,freq){}}},rect:function(w,h,freq){return console.error("STILL NEED TO BUILD THIS TRIANGLE"),{size:new Gamestack.Vector(w,h),width:w,height:h,freq:freq,points:[],fill:function(start,freq){}}},triangle:function(base,h,freq){return console.error("STILL NEED TO BUILD THIS TRIANGLE"),{base:base,height:height,freq:freq,points:[],fill:function(start,freq){}}}};Gamestack.Shapes=Shapes;var Shot=function(){function Shot(name,imageOrAnimation){_classCallCheck(this,Shot),this.name=name||"No-Name",imageOrAnimation instanceof Gamestack.GameImage?this.anime=new Animation(imageOrAnimation):imageOrAnimation instanceof Gamestack.Animation&&(this.anime=imageOrAnimation),this.rotation=0,this.rot_disp=0;var args=name instanceof Object?name:{};this.init(args)}return _createClass(Shot,[{key:"init",value:function(args){if(args instanceof Object)for(var x in args)this[x]=args[x],args[x]instanceof Object&&args[x].hasOwnProperty("x")&&(this[x]=new Vector(args[x]));Gamestack.Modifiers.informable(this)}},{key:"Image",value:function(image){this.anime=new Animation(image)}},{key:"Animation",value:function(anime){return this.anime=anime,this}},{key:"Total",value:function(total,rot_disp_per_unit){return this.total=total,this.rot_disp=rot_disp_per_unit,this}},{key:"WaveGrowth",value:function(growth){growth>0&&(this.curve_growth=growth)}},{key:"CurveMode",value:function(key,size,growth){return this.curve=Gamestack.Curves.InOut[key.toLowerCase()],this.curve_key=key.toLowerCase(),this.curve_size=size,growth>0&&(this.curve_growth=growth),"number"==typeof this.curve_size&&(this.curve_size=new Gamestack.Vector(this.curve_size,this.curve_size)),this}},{key:"RotDisp",value:function(rot_disp){return this.rot_disp=rot_disp,this}},{key:"Velocity",value:function(v){return this.velocity=v,this}},{key:"Position",value:function(p){return"number"==typeof p?this.position=new Gamestack.Vector(p,p,p):this.position=p,this}},{key:"Size",value:function(s){return"number"==typeof s?this.size=new Gamestack.Vector(s,s,s):this.size=s,this}},{key:"Rotation",value:function(r){return this.rotation=r,this}},{key:"onCollide",value:function(collideables,callback){}}]),Shot}();Gamestack.Shot=Shot;var Rectangle=function(){function Rectangle(min,max){_classCallCheck(this,Rectangle),this.min=new Gamestack.Vector(min),this.max=new Gamestack.Vector(max)}return _createClass(Rectangle,[{key:"toLine",value:function(){}}]),Rectangle}(),VectorBounds=Rectangle;Gamestack.VectorBounds=VectorBounds,Gamestack.Rectangle=Rectangle;var VectorFrameBounds=function(_Rectangle){function VectorFrameBounds(min,max,termPoint){_classCallCheck(this,VectorFrameBounds);var _this17=_possibleConstructorReturn(this,(VectorFrameBounds.__proto__||Object.getPrototypeOf(VectorFrameBounds)).call(this,min,max));return _this17.termPoint=termPoint||new Gamestack.Vector(_this17.max.x,_this17.max.y,_this17.max.z),_this17}return _inherits(VectorFrameBounds,_Rectangle),VectorFrameBounds}(Rectangle);Gamestack.VectorFrameBounds=VectorFrameBounds;
var Line=function(){function Line(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Line),this.curve_options=Curves,this.curve_string=args.curve_string||"linearNone",this.curve=this.get_curve_from_string(this.curve_string),this.motion_curve=args.motion_curve||TWEEN.Easing.Linear.None,"function"==typeof args.curve&&(this.curve=args.curve),this.points=args.points||[],this.position=args.position||new Gamestack.Vector,this.is_highlighted=args.is_highlighted||!1,this.offset=args.offset||new Gamestack.Vector,this.pointDist=5,this.size=args.size||new Gamestack.Vector,this.rotation=args.rotation||0,this.origin=args.origin||new Gamestack.Vector(0,0),this.iterations=1,this.growth=args.growth||1.2}return _createClass(Line,[{key:"Iterations",value:function(n){return this.iterations=n,this}},{key:"Growth",value:function(n){return this.growth=n,this}},{key:"Origin",value:function(o){return this.position=o,this.origin=o,this}},{key:"Pos",value:function(p){return this.origin=p,this.position=p,this}},{key:"PointDisp",value:function(num){return this.minPointDist=num,this}},{key:"Curve",value:function(c){return this.curve=c,this.curve_string=this.get_curve_string(c),this}},{key:"Duration",value:function(d){return this.duration=d,this}},{key:"Rotation",value:function(r){return this.rotation=r,this}},{key:"next",value:function(position){for(var found=!1,x=0;x<this.points.length;x++){if(position.equals(this.points[x])&&x<this.points.length-1)return found=!0,new Gamestack.Vector(this.points[x+1]);if(x==this.points.length-1&&!found)return new Gamestack.Vector(this.points[0])}}},{key:"get_curve_from_string",value:function(str){console.log("Applying Line():curve:"+str);for(var x in this.curve_options)if(x.toLowerCase()==str.toLowerCase())return this.curve_options[x]}},{key:"get_curve_string",value:function(c){for(var x in this.curve_options)if(this.curve_options[x]==c)return x}},{key:"getGraphCanvas",value:function(curveCall,existing_canvas){var canvas=existing_canvas||document.createElement("canvas");canvas.style.position="relative",canvas.id="curve-display",canvas.setAttribute("class","motion-curve"),canvas.width=180,canvas.height=100,canvas.style.background="black";var context=canvas.getContext("2d");context.fillStyle="rgb(0,0,0)",context.fillRect(0,0,180,100),context.lineWidth=.5,context.strokeStyle="rgb(230,230,230)",context.beginPath(),context.moveTo(0,20),context.lineTo(180,20),context.moveTo(0,80),context.lineTo(180,80),context.closePath(),context.stroke(),context.lineWidth=2,context.strokeStyle="rgb(255,127,127)";var position={x:0,y:80},position_old={x:0,y:80};this.test_graph_size=new Gamestack.Vector(185,60);var points=this.get_line_segment(this.test_graph_size,5,curveCall);for(var x in points){var position=new Gamestack.Vector(points[x].x,this.test_graph_size.y+20-points[x].y);context.beginPath(),context.moveTo(position_old.x,position_old.y),context.lineTo(position.x,position.y),context.closePath(),context.stroke(),position_old.x=position.x,position_old.y=position.y}return canvas}},{key:"transpose",value:function(origin,rotation){this.rotation=rotation,this.origin=origin;for(var t_points=[],x=0;x<this.points.length;x++){var p=this.points[x],np=new Gamestack.Vector(Gamestack.GeoMath.rotatePointsXY(p.x,p.y,this.rotation));t_points.push(np.add(origin)),console.log(np)}return t_points}},{key:"add_segment",value:function(next_segment,offset){for(var x=0;x<next_segment.length;x++)next_segment[x]=new Gamestack.Vector(next_segment[x]).add(offset),this.points.push(next_segment[x])}},{key:"get_flipped_segment",value:function(points){for(var t_points=points.slice(),t_len=t_points.length,x=0;x<points.length;x++)t_points[t_len-x].x=points[x].x;return t_points}},{key:"Highlight",value:function(origin,ctx){ctx=ctx||Gamestack.ctx;var points=this.transpose(origin);for(var x in points){var point=points[x],dist=point.sub(Gamestack.point_highlighter.position),d=Math.sqrt(dist.x*dist.x+dist.y*dist.y);d>=10&&(Gamestack.point_highlighter.position=new Gamestack.Vector(points[x])),Canvas.draw(Gamestack.point_highlighter,ctx)}return this}}]),Line}(),GeoMath={rotatePointsXY:function(x,y,angle){var theta=angle*Math.PI/180,point={};return point.x=x*Math.cos(theta)-y*Math.sin(theta),point.y=x*Math.sin(theta)+y*Math.cos(theta),point.z=0,point}};Gamestack.GeoMath=GeoMath;var Sound=function(){function Sound(src,data){if(_classCallCheck(this,Sound),"object"==("undefined"==typeof src?"undefined":_typeof(src))?(this.sound=document.createElement("audio"),this.sound.src=src.src,this.src=src.src):"string"==typeof src&&(this.sound=document.createElement("audio"),this.sound.src=src,this.src=src),"object"==("undefined"==typeof data?"undefined":_typeof(data)))for(var x in data)"sound"!==x&&(this[x]=data[x]);this.onLoad=this.onLoad||function(){},"function"==typeof this.onLoad&&this.onLoad(this.sound)}return _createClass(Sound,[{key:"Loop",value:function(loop){return this.sound.loop=loop||!0,this}},{key:"loop",value:function(_loop){return this.sound.loop=_loop||!0,this}},{key:"Volume",value:function(val){return this.sound.volume=val,this}},{key:"volume",value:function(val){return this.sound.volume=val,this}},{key:"Play",value:function(){return"object"==_typeof(this.sound)&&"function"==typeof this.sound.play&&this.sound.play(),this}},{key:"play",value:function(){return"object"==_typeof(this.sound)&&"function"==typeof this.sound.play&&this.sound.play(),this}}]),Sound}(),SoundList=function(){function SoundList(list){if(_classCallCheck(this,SoundList),this.cix=1,this.sounds=[],list instanceof Array)for(var x in list)list[x].src?this.sounds.push(new Sound(list[x].src,list[x])):"string"==typeof list[x]&&this.sounds.push(new Sound(list[x]))}return _createClass(SoundList,[{key:"add",value:function(src,name){if("object"==("undefined"==typeof src?"undefined":_typeof(src))&&src.src)this.sounds.push(new Sound(src.src,src));else if("string"==typeof src){var data={};name&&(data.name=name),this.sounds.push(new Sound(list[x],data))}}},{key:"Volume",value:function(v){for(var x=0;x<this.sounds.length;x++)this.sounds[x].volume(v);return this}},{key:"volume",value:function(v){for(var x=0;x<this.sounds.length;x++)this.sounds[x].volume(v);return this}},{key:"PlayNext",value:function(){this.sounds[this.cix%this.sounds.length].play(),this.cix+=1}},{key:"Play",value:function(){this.sounds[this.cix%this.sounds.length].play(),this.cix+=1}},{key:"playNext",value:function(){this.sounds[this.cix%this.sounds.length].play(),this.cix+=1}},{key:"play",value:function(){this.sounds[this.cix%this.sounds.length].play(),this.cix+=1}}]),SoundList}();Gamestack.Sound=Sound,Gamestack.SoundList=SoundList,function(){console.log("Sprite class... creating");var Sprite=function(){function Sprite(){var src=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},scale=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;_classCallCheck(this,Sprite);var args="object"==("undefined"==typeof src?"undefined":_typeof(src))?src:{};args instanceof Gamestack.Animation&&(args={selected_animation:args,image:args.image,size:new Gamestack.Vector(args.frameSize)}),"string"==typeof src&&(this.src=src,this.image=new Gamestack.GameImage(src),this.selected_animation=new Gamestack.Animation(src),this.selected_animation.setToSingleFrame()),this.animations=[],this.size=new Gamestack.Vector(0,0),"number"==typeof scale&&(this.scale=scale||1),Gamestack.Modifiers.spatial(this),this.active=!0,this.apply_args(args),this.selected_animation||this.setToSingleFrame()}return _createClass(Sprite,[{key:"onLoad",value:function(f){var __inst=this,img=this.image.domElement;img.onload;return img.onload=function(){onload(!1,__inst),f(!1,__inst)},img.onerror=function(err){f(!0,__inst)},this}},{key:"apply_args",value:function(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.FromData(args,!0),args.image instanceof Gamestack.GameImage&&!this.image&&(this.image=args.image),this.name=args.name||"__blankName",this.life=args.life||999999999999,this.description=args.description||"__spriteDesc",this.id=Gamestack.getArg(args,"id",this.create_id()),this.animations=Gamestack.getArg(args,"animations",[]),this.motions=Gamestack.getArg(args,"motions",[]),this.particles=Gamestack.getArg(args,"particles",[]),this.shots=Gamestack.getArg(args,"shots",[]),this.sounds=Gamestack.getArg(args,"sounds",[]),this.__initializers=Gamestack.getArg(args,"__initializers",[]),this.group=Gamestack.getArg(args,"group","one"),this.scrollFactor=args.scrollFactor||1,this.noScroll=args.noScroll||!1,this.noScroll&&(this.scrollFactor=0),this.speed=new Gamestack.Vector(Gamestack.getArg(args,"speed",new Gamestack.Vector(0,0))),this.size=new Gamestack.Vector(Gamestack.getArg(args,"size",new Gamestack.Vector(0,0))),this.position=new Gamestack.Vector(Gamestack.getArg(args,"position",new Gamestack.Vector(0,0,0))),this.collision_bounds=Gamestack.getArg(args,"collision_bounds",new Gamestack.VectorBounds(new Gamestack.Vector(0,0,0),new Gamestack.Vector(0,0,0))),this.rotation=new Gamestack.Vector(Gamestack.getArg(args,"rotation",new Gamestack.Vector(0,0,0))),this.scale=args.scale||1,this.acceleration=Gamestack.getArg(args,"acceleration",new Gamestack.Vector(0,0,0)),this.rot_speed=new Gamestack.Vector(Gamestack.getArg(args,"rot_speed",new Gamestack.Vector(0,0))),this.rot_accel=new Gamestack.Vector(Gamestack.getArg(args,"rot_accel",new Gamestack.Vector(0,0))),this.padding=Gamestack.getArg(args,"padding",new Gamestack.Vector(0,0,0));var __inst=this;Gamestack.each(this.shots,function(ix,item){__inst.shots[ix]=new Gamestack.Shot(item)}),Gamestack.each(this.sounds,function(ix,item){__inst.sounds[ix]=new Gamestack.Sound(item)}),Gamestack.each(this.motions,function(ix,item){__inst.motions[ix]=new Gamestack.TweenMotion(item)}),Gamestack.each(this.animations,function(ix,item){__inst.animations[ix]=new Gamestack.Animation(item)}),Gamestack.each(this.particles,function(ix,item){__inst.particles[ix]=new Gamestack.GSProton(item)}),Gamestack.each(this.__initializers,function(ix,item){__inst.onInit(item)}),Gamestack.Modifiers.informable(this),!this.selected_animation&&args.selected_animation&&(this.selected_animation=new Gamestack.Animation(args.selected_animation))}},{key:"FromData",value:function(){var data=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},fxlCopy=arguments.length>1&&void 0!==arguments[1]&&arguments[1];for(var x in data)(fxlCopy||"function"!=typeof data[x])&&(this[x]=data[x]);return this}},{key:"Scale",value:function(scaleFloat){return this.scale=scaleFloat,this.size=new Gamestack.Vector(this.image.domElement.width*scaleFloat,this.image.domElement.height*scaleFloat),this}},{key:"ScrollFactor",value:function(s){return this.scrollFactor=s,this}},{key:"engage",value:function(obj){obj.parent=this,obj.engage&&obj.engage()}},{key:"Life",value:function(v){return this.life=v,this}},{key:"singleFrame",value:function(){var __inst=this;return console.log("Sprite.singleFrame():"),__inst.size=__inst.size||new Gamestack.Vector(0,0),0==__inst.size.x&&0==__inst.size.y&&(__inst.size=new Gamestack.Vector(__inst.image.domElement.width,__inst.image.domElement.height),__inst.Scale(__inst.scale||1)),__inst.selected_animation||(console.log("setting Animation with :"+this.image.domElement.src),__inst.setAnimation(new Gamestack.Animation({image:__inst.image,frameSize:new Gamestack.Vector(__inst.image.domElement.width,__inst.image.domElement.height),frameBounds:new Gamestack.VectorFrameBounds(new Gamestack.Vector,new Gamestack.Vector)}))),this}},{key:"init",value:function(){}},{key:"onInit",value:function(fun){if("string"==typeof fun){this.__initializers.indexOf(fun)<0&&this.__initializers.push(fun);var __inst=this,keys=fun.split(".");if(console.log("finding init from string:"+fun),!keys.length>=2)return console.error('need min 2 string keys separated by "."');var f=Gamestack.options.SpriteInitializers[keys[0]][keys[1]];if("function"==typeof f){var __inst=this,f_init=this.init;this.init=function(){f_init(__inst),f(__inst)}}}else if("function"==typeof fun){console.log("extending init:");var f_init=this.init,__inst=this;this.init=function(){f_init(__inst),fun(__inst)}}else"object"==("undefined"==typeof fun?"undefined":_typeof(fun))&&(console.log("extending init:"),console.info("Quick2D does not yet implement onInit() from arg of object type"))}},{key:"get_id",value:function(){return this.id}},{key:"to_map_object",value:function(size,framesize){return this.__mapSize=new Gamestack.Vector(size||this.size),this.frameSize=new Gamestack.Vector(framesize||this.size),this}},{key:"create_id",value:function(){return Gamestack.create_id()}},{key:"setSize",value:function(size){this.size=new Gamestack.Vector(size.x,size.y,size.z)}},{key:"setPos",value:function(pos){this.position=new Gamestack.Vector(pos.x,pos.y,pos.z||0)}},{key:"setFrame",value:function(ix){this.selected_animation&&(this.selected_animation.selected_frame=this.selected_animation.frames[ix])}},{key:"getSizeByMax",value:function(mx,my){var size=new Gamestack.Vector(this.size),wth=size.y/size.x,htw=size.x/size.y;return size.x>mx&&(size.x=mx,size.y=size.x*wth),size.y>my&&(size.y=my,size.x=size.y*htw),size}},{key:"assertSpeed",value:function(){this.speed||(this.speed=new Gamestack.Vector(0,0,0))}},{key:"setAnimation",value:function(anime){return anime instanceof Gamestack.Animation&&this.animations.indexOf(anime)<0&&this.animations.push(anime),this.selected_animation=anime,this.image=this.selected_animation.image||new Gamestack.GameImage(this.selected_animation.src),Gamestack.log("set the animation"),this}},{key:"setToSingleFrame",value:function(){if(!this.image||!this.image.domElement)return this;var __inst=this,load=this.image.domElement.onload||function(){};return this.image.domElement.onload=function(){load(!1,__inst),__inst.size=new Gamestack.Vector(__inst.image.domElement.width,__inst.image.domElement.height),__inst.selected_animation=new Gamestack.Animation(__inst.image).FrameSize(__inst.size),__inst.Scale(__inst.scale||1)},Gamestack.log("set single-frame animation"),this}},{key:"LifeSpan",value:function(value){this.life=value}},{key:"Life",value:function(value){this.life=value}},{key:"isDead",value:function(gw){return gw=gw||Gamestack.game_windows[0],this.hasOwnProperty("life")&&this.life<=0}},{key:"die",value:function(gw){return this.life=0,this}},{key:"onScreen",value:function(w,h,gw){w=w||Gamestack.WIDTH,h=h||Gamestack.HEIGHT,gw=gw||Gamestack.game_windows[0];var camera=gw.camera||Gamestack.camera||{position:new Gamestack.Vector(0,0,0)},scrollFactor=this.noScroll?0:this.scrollFactor,camPos=new Gamestack.Vector(camera.position).mult(scrollFactor),p=new Gamestack.Vector(this.position.x-camPos.x,this.position.y-camPos.y,this.position.z-camPos.z);return p.x+this.size.x>-1e3-w&&p.x<w+1e3&&p.y+this.size.y>-1e3-h&&p.y<h+1e3}},{key:"update",value:function(sprite){}},{key:"def_update",value:function(sprite){this.hasOwnProperty("life")&&!isNaN(this.life)&&(this.life-=1);for(var x in this.speed)(this.speed[x]>0||this.speed[x]<0)&&(this.position[x]+=this.speed[x]);for(var x in this.acceleration)(this.acceleration[x]>0||this.acceleration[x]<0)&&(this.speed[x]+=this.acceleration[x]);for(var x in this.rot_speed)(this.rot_speed[x]>0||this.rot_speed[x]<0)&&(this.rotation[x]+=this.rot_speed[x]);for(var x in this.rot_accel)(this.rot_accel[x]>0||this.rot_accel[x]<0)&&(this.rot_speed[x]+=this.rot_accel[x])}},{key:"resolveFunctionFromDoubleKeys",value:function(keyString1,keyString2,obj,callback){callback("function"==typeof obj[keyString1][keyString2]?obj[keyString1][keyString2]:{})}},{key:"extendFunc",value:function(fun,extendedFunc){console.log("extending func");var ef=extendedFunc,__inst=this;return function(){ef(__inst),fun(__inst)}}},{key:"onUpdate",value:function(fun){var id=this.create_id();fun=this["update_"+id]=fun||function(){};var update=this.update;this.update=function(__inst){update(__inst);for(var x in __inst)__inst[x]==fun&&__inst[x](__inst)}}},{key:"travelLineTwoWay",value:function(lineObject,speed,curveKey,offset){speed=speed||1;curveKey=curveKey||"linear";var line=lineObject;lineObject.line&&(line=lineObject.line),this.__crtLineIx=this.__crtLineIx||0;var __inst=this,pctFloat=__inst.__crtLineIx%((line.points.length-1)/2)/((line.points.length-1)/2);__inst.__crtLineIx>=(line.points.length-1)/2&&(pctFloat=1-pctFloat);var ixChange=Gamestack.Curves.InOut[curveKey](pctFloat)*speed*.5;"linear"==curveKey&&(ixChange=speed),ixChange=Math.ceil(ixChange),ixChange<1&&(ixChange=1),__inst.position=new Gamestack.Vector(line.points[__inst.__crtLineIx]),__inst.__crtLineIx+=ixChange,__inst.__crtLineIx>=line.points.length&&(line.points=line.points.reverse(),__inst.__crtLineIx=0),offset instanceof Gamestack.Vector&&(this.position=this.position.add(offset))}},{key:"travelLineOnLoop",value:function(lineObject,speed,curveKey,offset){speed=speed||1;curveKey=curveKey||"linear";var line=lineObject;lineObject.line&&(line=lineObject.line),this.__crtLineIx=this.__crtLineIx||0;var __inst=this,pctFloat=__inst.__crtLineIx%((line.points.length-1)/2)/((line.points.length-1)/2);__inst.__crtLineIx>=(line.points.length-1)/2&&(pctFloat=1-pctFloat);var ixChange=Gamestack.Curves.InOut[curveKey](pctFloat)*speed*.5;"linear"==curveKey&&(ixChange=speed),ixChange=Math.ceil(ixChange),ixChange<1&&(ixChange=1),__inst.position=new Gamestack.Vector(line.points[__inst.__crtLineIx]),__inst.__crtLineIx+=ixChange,__inst.__crtLineIx>=line.points.length&&(__inst.__crtLineIx=0),offset instanceof Gamestack.Vector&&(this.position=this.position.add(offset))}},{key:"hasColorCollision",value:function(sprite){var grid1=this.selected_animation.getCurrentColorMap()||[{position:this.position,size:this.size}],grid2=sprite.selected_animation.getCurrentColorMap()||[{position:spr.position,size:sprite.size}];for(var x in grid1)for(var y in grid2)if(Gamestack.Collision.basicBoxCollision(grid1[x].position,grid1[x].size,grid2[y].position,grid2[y].size))return!0;return!1}},{key:"hasBoxCollision",value:function(sprite){return Gamestack.Collision.spriteRectanglesCollide(this,sprite)}},{key:"shoot",value:function(options,gw){gw=gw||Gamestack.game_windows[0],this.prep_key="shoot";for(var animation=options.bullet||options.animation||options.anime||new Gamestack.Animation,speed=options.speed||options.velocity||1,size=options.size||new Gamestack.Vector(10,10,0),position=new Gamestack.Vector(options.position)||new Gamestack.Vector(this.position),rot_offset=options.rot_offset||options.rotation||0,total=options.total||1,rot_disp=options.rot_disp||0,curve=options.curve,curve_size=options.curve_size,curve_key=(options.curve_growth||1,options.curve_key||"quintic"),shots=(options.life||900,[]),x=0;x<total;x++){if(Gamestack.isAtPlay){var bx=position.x,by=position.y,shot=(size.x,size.y,new Gamestack.Sprite({active:!0,position:new Gamestack.Vector(position),size:new Gamestack.Vector(size),speed:speed,image:animation.image,rotation:new Gamestack.Vector(0,0,0),flipX:!1,life:options.life}));shot.noScroll=!0,shot.setAnimation(animation),rot_offset=new Gamestack.Vector(rot_offset,0,0),shot.position.x=bx,shot.position.y=by;var div=rot_disp/total,rotPlus=div*x+div/2-rot_disp/2;if(shot.rotation.x=rot_offset.x+rotPlus,shot.origin=new Gamestack.Vector(position),shot.speed=new Gamestack.Vector(Math.cos(3.14*shot.rotation.x/180)*speed,Math.sin(3.14*shot.rotation.x/180)*speed),shots.push(shot),curve){shot.ticker=0;var r=shot.rotation.x+0;shot.line=(new Gamestack.CurvedLine).Pos(position).Curve(curve_key).SegmentSize(curve_size).MaxSize(2e3).Growth(1.5).Rotate(r).Fill(),shot.onUpdate(function(spr){spr.ticker+=1,spr.ticker<spr.line.points.length&&(spr.position=new Gamestack.Vector(spr.line.points[spr.ticker]))})}else shot.onUpdate(function(spr){});gw.add(shot)}}return shots}},{key:"subsprite",value:function subsprite(options,gw){gw=gw||Gamestack.game_windows[0];var animation=options.animation||new Gamestack.Animation,position=options.position||new Gamestack.Vector(this.position),offset=options.offset||new Gamestack.Vector(0,0,0),size=new Gamestack.Vector(options.size||this.size);if(Gamestack.isAtPlay){var subsprite=gw.add(new Gamestack.Sprite({active:!0,position:position,size:size,offset:offset,image:animation.image,rotation:new Gamestack.Vector(0,0,0),flipX:!1,scrollFactor:this.scrollFactor,noScroll:this.noScroll}));return subsprite.setAnimation(animation),subsprite}alert("No subsprite when not at play")}},{key:"animate",value:function(animation){Gamestack.isAtPlay&&(animation&&this.setAnimation(animation),this.selected_animation.animate())}},{key:"onAnimationComplete",value:function(fun){this.selected_animation.onComplete(fun)}},{key:"accelY",value:function(accel,max){accel=Math.abs(accel),"number"==typeof max&&(max={y:max}),this.assertSpeed();var diff=max.y-this.speed.y;diff>0&&(this.speed.y+=Math.abs(diff)>=accel?accel:diff),diff<0&&(this.speed.y-=Math.abs(diff)>=accel?accel:diff)}},{key:"accelX",value:function(accel,max){accel=Math.abs(accel),"number"==typeof max&&(max={x:max}),this.assertSpeed();var diff=max.x-this.speed.x;diff>0&&(this.speed.x+=Math.abs(diff)>=accel?accel:diff),diff<0&&(this.speed.x-=Math.abs(diff)>=accel?accel:diff)}},{key:"decelY",value:function(amt){amt=Math.abs(amt),Math.abs(this.speed.y)<=amt?this.speed.y=0:this.speed.y>amt?this.speed.y-=amt:this.speed.y<amt*-1&&(this.speed.y+=amt)}},{key:"decelX",value:function(amt){amt=Math.abs(amt),this.speed.x>amt?this.speed.x-=amt:this.speed.x<amt*-1&&(this.speed.x+=amt),Math.abs(this.speed.x)<=amt&&(this.speed.x=0)}},{key:"accel",value:function(object,key,_accel,max){var prop=object;_accel=Math.abs(_accel),"number"==typeof max&&(max={x:max});var diff=(prop[key],max.x-prop[key]);diff>0&&(prop[key]+=Math.abs(diff)>=_accel?_accel:diff),diff<0&&(prop[key]-=Math.abs(diff)>=_accel?_accel:diff)}},{key:"decel",value:function(prop,key,rate){"object"==("undefined"==typeof rate?"undefined":_typeof(rate))&&(rate=rate.rate),rate=Math.abs(rate),Math.abs(prop[key])<=rate?prop[key]=0:prop[key]>0?prop[key]-=rate:prop[key]<0?prop[key]+=rate:prop[key]=0}},{key:"SmoothMotion",value:function(x,y,duration){if("object"==("undefined"==typeof x?"undefined":_typeof(x))&&(duration=y,y=x.y,x=x.x),x+=this.position.x,y+=this.position.y,!TWEEN instanceof Object)return console.error("TWEEN.js required for SmoothMotion();");var t=new TWEEN.Tween(this.position).easing(TWEEN.Easing.Quadratic.InOut).to(new Gamestack.Vector(x,y),duration).onUpdate(function(){}).onComplete(function(){});t.start()}},{key:"SmoothRotate",value:function(r,duration){if(!TWEEN instanceof Object)return console.error("TWEEN.js required for SmoothRotate();");r+=this.rotation.x;var t=new TWEEN.Tween(this.rotation).easing(TWEEN.Easing.Quadratic.InOut).to(new Gamestack.Vector(r),duration).onUpdate(function(){}).onComplete(function(){});t.start()}},{key:"center",value:function(){return new Gamestack.Vector(this.position.x+this.size.x/2,this.position.y+this.size.y/2,0)}},{key:"shortest_stop",value:function(item,callback){var diff_min_y=item.min?item.min.y:Math.abs(item.position.y-this.position.y+this.size.y),diff_min_x=item.min?item.min.x:Math.abs(item.position.x-this.position.x+this.size.x),diff_max_y=item.max?item.max.y:Math.abs(item.position.y+item.size.y-this.position.y),diff_max_x=item.max?item.max.x:Math.abs(item.position.x+item.size.x-this.position.y),dimens={top:diff_min_y,left:diff_min_x,bottom:diff_max_y,right:diff_max_x},minkey="",min=1e7;for(var x in dimens)dimens[x]<min&&(min=dimens[x],minkey=x);callback(minkey)}},{key:"overlap_x",value:function(item,padding){padding||(padding=0);var paddingX=Math.round(padding*this.size.x),paddingY=Math.round(padding*this.size.y),left=this.position.x+paddingX,right=this.position.x+this.size.x-paddingX;this.position.y+paddingY,this.position.y+this.size.y-paddingY;return right>item.position.x&&left<item.position.x+item.size.x}},{key:"overlap_y",value:function(item,padding){padding||(padding=0);var paddingX=Math.round(padding*this.size.x),paddingY=Math.round(padding*this.size.y),top=(this.position.x+paddingX,this.position.x+this.size.x-paddingX,this.position.y+paddingY),bottom=this.position.y+this.size.y-paddingY;return bottom>item.position.y&&top<item.position.y+item.size.y}},{key:"collide_stop_x",value:function(item){for(var apart=!1,ct=1e4;!apart&&ct>0;){ct--;var diffX=this.center().sub(item.center()).x,distX=Math.abs(this.size.x/2+item.size.x/2-Math.round(this.size.x*this.padding.x));Math.abs(diffX)<distX?this.position.x-=diffX>0?-1:1:(this.speed.x=0,apart=!0)}}},{key:"collide_stop",value:function(item){if(this.id==item.id)return!1;if(this.speed=this.speed||new Gamestack.Vector(0,0,0),this.padding=this.padding||new Gamestack.Vector(0,0,0),this.hasBoxCollision(item)){var diff=this.center().sub(item.center());if(this.overlap_x(item,this.padding.x+.1)&&Math.abs(diff.x)<Math.abs(diff.y))for(var apart=!1,ct=1e4;!apart&&ct>0;){ct--;var diffY=this.center().sub(item.center()).y,distY=Math.abs(this.size.y/2+item.size.y/2-Math.round(this.size.y*this.padding.y));if(!(Math.abs(diffY)<distY))return diffY<=0&&(this.__inAir=!1),this.speed.y=0,apart=!0;this.position.y-=diffY>0?-1:diffY<0?1:0,this.position.y=Math.round(this.position.y)}this.overlap_y(item,this.padding.y)&&Math.abs(diff.y)<Math.abs(diff.x)&&this.collide_stop_x(item)}}},{key:"collide_stop_top",value:function(item){if(this.id==item.id)return!1;if(this.overlap_x(item,this.padding.x+.1)){console.log("OVERLAP_X");var paddingY=this.padding.y*this.size.y;this.position.y+this.size.y-paddingY<=item.position.y&&(this.groundMaxY=item.position.y-this.size.y+paddingY)}}},{key:"restoreFrom",value:function(data){return data.image=new GameImage(data.src||data.image.src),new Gamestack.Sprite(data)}},{key:"fromFile",value:function(file_path){if("string"==typeof file_path){var __inst=this;$.getJSON(file_path,function(data){__inst=new Gamestack.Sprite(data)})}}},{key:"toJSONString",value:function(){return jstr(JSON.decycle(this))}}]),Sprite}();Gamestack.Sprite=Sprite}(),function(){console.log("Vector class... creating");var Vector=function(){function Vector(x,y,z,r){_classCallCheck(this,Vector);var copied=!1;"object"==("undefined"==typeof x?"undefined":_typeof(x))&&x.hasOwnProperty("x")&&x.hasOwnProperty("y")&&(this.x=x.x,this.y=x.y,this.z=x.z||0,null==this.z&&(this.z=0),this.valid_check(),copied=!0),null==z&&(z=0),copied||(this.x=x,this.y=y,this.z=z,this.r=r,this.valid_check())}return _createClass(Vector,[{key:"valid_check",value:function(){void 0==this.x&&(this.x=0),void 0==this.y&&(this.y=0),void 0==this.z&&(this.z=0)}},{key:"sub",value:function(v){return"number"==typeof v&&(v={x:v,y:v,z:v}),new Gamestack.Vector(this.x-v.x,this.y-v.y,this.z-v.z)}},{key:"add",value:function(v){return"number"==typeof v&&(v={x:v,y:v,z:v}),new Gamestack.Vector(this.x+v.x,this.y+v.y,this.z+v.z)}},{key:"mult",value:function(v){return"number"==typeof v&&(v={x:v,y:v,z:v}),new Gamestack.Vector(this.x*v.x,this.y*v.y,this.z*v.z)}},{key:"div",value:function(v){return"number"==typeof v&&(v={x:v,y:v,z:v}),new Gamestack.Vector(this.x/v.x,this.y/v.y,this.z/v.z)}},{key:"round",value:function(){return new Gamestack.Vector(Math.round(this.x),Math.round(this.y),Math.round(this.z))}},{key:"floor",value:function(){return new Gamestack.Vector(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z))}},{key:"ceil",value:function(){return new Gamestack.Vector(Math.ceil(this.x),Math.ceil(this.y),Math.ceil(this.z))}},{key:"equals",value:function(v){return this.x==v.x&&this.y==v.y&&this.z==v.z}},{key:"trig_distance_xy",value:function(v){var dist=this.sub(v);return Math.sqrt(dist.x*dist.x+dist.y*dist.y)}},{key:"is_between",value:function(v1,v2){return this.x>=v1.x&&this.x<=v2.x&&this.y>=v1.y&&this.y<=v2.y&&this.z>=v1.z&&this.z<=v2.z}},{key:"randomize",value:function(minFloat,maxFloat){var random=1e3*(Math.random()*(maxFloat-minFloat)+minFloat)/1e3;return this.mult(random)}},{key:"rotationalSpeedPoint",value:function(rotation,speed){var r=rotation;return isNaN(speed)&&(speed=1),"object"==("undefined"==typeof rotation?"undefined":_typeof(rotation))&&rotation.x&&(r=rotation.x),new Gamestack.Vector(Math.cos(3.14*r/180)*speed,Math.sin(3.14*r/180)*speed)}},{key:"angleBetween",value:function(p1,p2){return 180*Math.atan2(p2.y-p1.y,p2.x-p1.x)/Math.PI}}]),Vector}();Gamestack.Vector=Vector,Gamestack.Rotation=Vector,Gamestack.Pos=Vector,Gamestack.Position=Vector,Gamestack.Size=Vector;var VectorMath={rotatePointsXY:function(x,y,angle){var theta=angle*Math.PI/180,point={};return point.x=x*Math.cos(theta)-y*Math.sin(theta),point.y=x*Math.sin(theta)+y*Math.cos(theta),point.z=0,point}};Gamestack.VectorMath=VectorMath}();var Background=function(_Gamestack$Sprite){function Background(){var arg1=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arg2=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,Background);var _this18=_possibleConstructorReturn(this,(Background.__proto__||Object.getPrototypeOf(Background)).call(this,arg1,arg2)),args="object"==("undefined"==typeof arg1?"undefined":_typeof(arg1))?arg1:{};return _this18.type=args.type||"parallax"||"basic"||!1,_this18.source_objects=args.objects||args.source_objects||[],_this18.members=[],_this18.rows=args.rows||1,_this18.cols=args.cols||1,_this18.flip=args.flip||!1,_this18.fill=args.fill||!1,_this18.flip=args.flip||!1,_this18}return _inherits(Background,_Gamestack$Sprite),_createClass(Background,[{key:"Flip",value:function(value){return void 0==value?this.flip=!0:1!=value&&0!=value||(this.flip=value),this}},{key:"Rows",value:function(r){return this.rows=r,this}},{key:"Cols",value:function(c){return this.cols=c,this}},{key:"Fill",value:function(approxRows,approxCols,gw){approxRows=approxRows||this.rows||1,approxCols=approxCols||this.cols||1,this.members.push(new Background(this));for(var x=0;x<this.source_objects.length;x++)this.members.push(new Background(this.source_objects[x]));gw=gw||Gamestack.game_windows[0];for(var xBacksTotal=(gw.canvas.width,gw.canvas.height,Math.floor(approxRows/2)),yBacksTotal=Math.floor(approxCols/2),y=-yBacksTotal;y<=yBacksTotal+1;y++){console.log("adding background:"+y);for(var x=-xBacksTotal;x<=xBacksTotal+1;x++){this.members.push(new Background(this));var b=this.members[this.members.length-1];b.setSize(this.size);b.position.x=x*this.size.x,b.position.y=y*this.size.y,b.minX=-xBacksTotal*b.size.x+b.size.x,b.maxX=(xBacksTotal+1)*b.size.x,b.minY=-yBacksTotal*b.size.y+b.size.y,b.maxY=yBacksTotal*b.size.y,x%2==0&&(b.flipX=!0),y%2==0&&(b.flipY=!0),b.onUpdate(function(spr){spr.campos=gw.camera.position;var cx=spr.campos.x-spr.campos.x%spr.size.x,cy=spr.campos.y-spr.campos.y%spr.size.y;spr.position.x-cx<spr.minX&&(spr.position.x=spr.maxX+cx),spr.position.x-cx>spr.maxX&&(spr.position.x=spr.minX+cx),spr.position.y-cy<spr.minY&&(spr.position.y=spr.maxY+cy),spr.position.y-cy>spr.maxY&&(spr.position.y=spr.minY+cy)}),gw.add(b)}}return this}},{key:"add",value:function(object){var cleanCheck=object instanceof Gamestack.Sprite||object instanceof Array&&object[0]instanceof Gamestack.Sprite;return cleanCheck?(object instanceof Array?this.source_objects.cancat(object):this.source_objects.push(object),this):console.error("Must have: valid contents (Gamestack.Sprite OR [] of Gamestack.Sprite())")}}]),Background}(Gamestack.Sprite);Gamestack.Background=Background,function(){console.log("Interactive class... creating");var Interactive=function(_Gamestack$Sprite2){function Interactive(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Interactive);var _this19=_possibleConstructorReturn(this,(Interactive.__proto__||Object.getPrototypeOf(Interactive)).call(this,args));return _this19.collision_settings=new Gamestack.CollisionSettings(args),_this19.collideables=args.collideables||[],Gamestack.Extendors.collideable(_this19,args),_this19}return _inherits(Interactive,_Gamestack$Sprite2),_createClass(Interactive,[{key:"Collideables",value:function(c){return this.collideables=c||[],!this.collideables instanceof Array?console.error('Must pass array for "c" argument'):this;
}},{key:"onCollide",value:function(){}}]),Interactive}(Gamestack.Sprite);Gamestack.Interactive=Interactive}(),function(){console.log("Terrain class... creating");var Terrain=function(_Gamestack$Sprite3){function Terrain(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Terrain);var _this20=_possibleConstructorReturn(this,(Terrain.__proto__||Object.getPrototypeOf(Terrain)).call(this,args));return _this20.collision_settings=new Gamestack.CollisionSettings(args),_this20.collideables=args.collideables||args.colliders||[],Gamestack.Extendors.collideable(_this20,args),_this20}return _inherits(Terrain,_Gamestack$Sprite3),_createClass(Terrain,[{key:"Collideables",value:function(c){return this.collideables=c||[],!this.collideables instanceof Array?console.error('Must pass array for "c" argument'):this}},{key:"onCollide",value:function(){}}]),Terrain}(Gamestack.Sprite);Gamestack.Terrain=Terrain}();var THREE_EXT={defaults:{DodecahedronGeometry:{radius:1,detail:0},SphereGeometry:{radius:5,widthSegments:32,heightSegments:32},BoxGeometry:{width:20,height:20,depth:20},CylinderGeometry:{radiusTop:5,radiusBottom:5,height:20,heightSegments:32},TorusGeometry:{radius:10,tube:3,radialSegments:16,tubularSegments:100}}},Three=function(_Gamestack$Sprite4){function Three(){var args=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Three);var _this21=_possibleConstructorReturn(this,(Three.__proto__||Object.getPrototypeOf(Three)).call(this,args));if(!THREE){var _ret;return _ret=console.error("ThreeJSObject():Library: Three.js is required for this object."),_possibleConstructorReturn(_this21,_ret)}_this21.scene=new THREE.Scene,args.geometry instanceof String&&THREE[args.geometry]?_this21.geometry=new THREE[args.geometry]:_this21.geometry=args.geometry||new THREE.TorusGeometry(50,10,16,100),_this21.scene.add(new THREE.AmbientLight(16777215,1)),_this21.renderer=Gamestack.renderer||new THREE.WebGLRenderer({preserveDrawingBuffer:!0,alpha:!0}),_this21.renderer.setSize(1e3,1e3),_this21.camera=new THREE.PerspectiveCamera(70,1,1,1e3),_this21.camera.position.z=125;var __inst=_this21,src=args.src||"../assets/game/image/tiles/perlin_3.png";return __inst.loader=new THREE.TextureLoader,__inst.loader.load(src,function(texture){__inst.material=args.material||new THREE.MeshPhongMaterial({map:texture}),__inst.__init||(__inst.mesh=new THREE.Mesh(__inst.geometry,__inst.material),__inst.scene.add(__inst.mesh),__inst.__init=!0),__inst.renderer.render(__inst.scene,__inst.camera),__ServerSideFile.file_upload("test.png",__inst.renderer.domElement.toDataURL("image/png"),function(relpath,content){relpath=relpath.replace("client/","../"),__inst.selected_animation=new Animation({src:relpath,frameSize:new Vector(1e3,1e3),frameBounds:new VectorFrameBounds(new Vector(0,0,0),new Vector(0,0,0),new Vector(0,0,0))}).singleFrame(),__inst.selected_animation.image.domElement.onload=function(){__inst.setSize(new Vector(__inst.selected_animation.image.domElement.width,__inst.selected_animation.image.domElement.height)),__inst.selected_animation.animate(),console.log(jstr(__inst.selected_animation.frames))}})}),_this21}return _inherits(Three,_Gamestack$Sprite4),_createClass(Three,[{key:"three_update",value:function(){console.log("THREE --GS-Object UPDATE"),this.mesh.rotation.y+=.05,this.renderer.clear(),this.renderer.setSize(this.size.x,this.size.y);var pixels=new Uint8Array(this.size.x*this.size.y*4);this.renderer.render(this.scene,this.camera);var gl=this.renderer.getContext();gl.readPixels(0,0,this.size.x,this.size.y,gl.RGBA,gl.UNSIGNED_BYTE,pixels),this.selected_animation.selected_frame={image:{}},this.selected_animation.selected_frame.image.data=new ImageData(new Uint8ClampedArray(pixels),this.size.x,this.size.y)}},{key:"applyAnimativeState",value:function(){}}]),Three}(Gamestack.Sprite);"function"!=typeof JSON.decycle&&(JSON.decycle=function(object){var objects=[],paths=[];return function derez(value,path){var i,name,nu;switch("undefined"==typeof value?"undefined":_typeof(value)){case"object":if(!value)return null;for(i=0;i<objects.length;i+=1)if(objects[i]===value)return{$ref:paths[i]};if(objects.push(value),paths.push(path),"[object Array]"===Object.prototype.toString.apply(value))for(nu=[],i=0;i<value.length;i+=1)nu[i]=derez(value[i],path+"["+i+"]");else{nu={};for(name in value)Object.prototype.hasOwnProperty.call(value,name)&&(nu[name]=derez(value[name],path+"["+JSON.stringify(name)+"]"))}return nu;case"number":case"string":case"boolean":return value}}(object,"$")}),"function"!=typeof JSON.retrocycle&&(JSON.retrocycle=function retrocycle($){var px=/^\$(?:\[(?:\d?|\"(?:[^\\\"\u0000-\u001f]|\\([\\\"\/bfnrt]|u[0-9a-zA-Z]{4}))*\")\])*$/;return function rez(value){var i,item,name,path;if(value&&"object"===("undefined"==typeof value?"undefined":_typeof(value)))if("[object Array]"===Object.prototype.toString.apply(value))for(i=0;i<value.length;i+=1)item=value[i],item&&"object"===("undefined"==typeof item?"undefined":_typeof(item))&&(path=item.$ref,"string"==typeof path&&px.test(path)?value[i]=eval(path):rez(item));else for(name in value)"object"===_typeof(value[name])&&(item=value[name],item&&(path=item.$ref,"string"==typeof path&&px.test(path)?value[name]=eval(path):rez(item)))}($),$});var Stats=function Stats(){function addPanel(panel){return container.appendChild(panel.dom),panel}function showPanel(id){for(var i=0;i<container.children.length;i++)container.children[i].style.display=i===id?"block":"none";mode=id}var mode=0,container=document.createElement("div");container.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",container.addEventListener("click",function(event){event.preventDefault(),showPanel(++mode%container.children.length)},!1);var beginTime=(performance||Date).now(),prevTime=beginTime,frames=0,fpsPanel=addPanel(new Stats.Panel("FPS","#0ff","#002")),msPanel=addPanel(new Stats.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var memPanel=addPanel(new Stats.Panel("MB","#f08","#201"));return showPanel(0),{REVISION:16,dom:container,addPanel:addPanel,showPanel:showPanel,begin:function(){beginTime=(performance||Date).now()},end:function(){frames++;var time=(performance||Date).now();if(msPanel.update(time-beginTime,200),time>=prevTime+1e3&&(fpsPanel.update(1e3*frames/(time-prevTime),100),prevTime=time,frames=0,memPanel)){var memory=performance.memory;memPanel.update(memory.usedJSHeapSize/1048576,memory.jsHeapSizeLimit/1048576)}return time},update:function(){beginTime=this.end()},domElement:container,setMode:showPanel}};Stats.Panel=function(name,fg,bg){var min=1/0,max=0,round=Math.round,PR=round(window.devicePixelRatio||1),WIDTH=80*PR,HEIGHT=48*PR,TEXT_X=3*PR,TEXT_Y=2*PR,GRAPH_X=3*PR,GRAPH_Y=15*PR,GRAPH_WIDTH=74*PR,GRAPH_HEIGHT=30*PR,canvas=document.createElement("canvas");canvas.width=WIDTH,canvas.height=HEIGHT,canvas.style.cssText="width:80px;height:48px";var context=canvas.getContext("2d");return context.font="bold "+9*PR+"px Helvetica,Arial,sans-serif",context.textBaseline="top",context.fillStyle=bg,context.fillRect(0,0,WIDTH,HEIGHT),context.fillStyle=fg,context.fillText(name,TEXT_X,TEXT_Y),context.fillRect(GRAPH_X,GRAPH_Y,GRAPH_WIDTH,GRAPH_HEIGHT),context.fillStyle=bg,context.globalAlpha=.9,context.fillRect(GRAPH_X,GRAPH_Y,GRAPH_WIDTH,GRAPH_HEIGHT),{dom:canvas,update:function(value,maxValue){min=Math.min(min,value),max=Math.max(max,value),context.fillStyle=bg,context.globalAlpha=1,context.fillRect(0,0,WIDTH,GRAPH_Y),context.fillStyle=fg,context.fillText(round(value)+" "+name+" ("+round(min)+"-"+round(max)+")",TEXT_X,TEXT_Y),context.drawImage(canvas,GRAPH_X+PR,GRAPH_Y,GRAPH_WIDTH-PR,GRAPH_HEIGHT,GRAPH_X,GRAPH_Y,GRAPH_WIDTH-PR,GRAPH_HEIGHT),context.fillRect(GRAPH_X+GRAPH_WIDTH-PR,GRAPH_Y,PR,GRAPH_HEIGHT),context.fillStyle=bg,context.globalAlpha=.9,context.fillRect(GRAPH_X+GRAPH_WIDTH-PR,GRAPH_Y,PR,round((1-value/maxValue)*GRAPH_HEIGHT))}}};var TWEEN=TWEEN||function(){var _tweens=[];return{getAll:function(){return _tweens},removeAll:function(){_tweens=[]},add:function(tween){_tweens.push(tween)},remove:function(tween){var i=_tweens.indexOf(tween);i!==-1&&_tweens.splice(i,1)},update:function(time,preserve){if(0===_tweens.length)return!1;var i=0;for(time=void 0!==time?time:TWEEN.now();i<_tweens.length;)_tweens[i].update(time)||preserve?i++:_tweens.splice(i,1);return!0}}}();TWEEN.now=Date.now,TWEEN.Tween=function(object){var _repeatDelayTime,_object=object,_valuesStart={},_valuesEnd={},_valuesStartRepeat={},_duration=1e3,_repeat=0,_yoyo=!1,_isPlaying=!1,_reversed=!1,_delayTime=0,_startTime=null,_easingFunction=TWEEN.Easing.Linear.None,_interpolationFunction=TWEEN.Interpolation.Linear,_chainedTweens=[],_onStartCallback=null,_onStartCallbackFired=!1,_onUpdateCallback=null,_onCompleteCallback=null,_onStopCallback=null;for(var field in object)_valuesStart[field]=parseFloat(object[field],10);this.to=function(properties,duration){return void 0!==duration&&(_duration=duration),_valuesEnd=properties,this},this.start=function(time){TWEEN.add(this),_isPlaying=!0,_onStartCallbackFired=!1,_startTime=void 0!==time?time:TWEEN.now(),_startTime+=_delayTime;for(var property in _valuesEnd){if(_valuesEnd[property]instanceof Array){if(0===_valuesEnd[property].length)continue;_valuesEnd[property]=[_object[property]].concat(_valuesEnd[property])}void 0!==_object[property]&&(_valuesStart[property]=_object[property],_valuesStart[property]instanceof Array==!1&&(_valuesStart[property]*=1),_valuesStartRepeat[property]=_valuesStart[property]||0)}return this},this.stop=function(){return _isPlaying?(TWEEN.remove(this),_isPlaying=!1,null!==_onStopCallback&&_onStopCallback.call(_object,_object),this.stopChainedTweens(),this):this},this.end=function(){return this.update(_startTime+_duration),this},this.stopChainedTweens=function(){for(var i=0,numChainedTweens=_chainedTweens.length;i<numChainedTweens;i++)_chainedTweens[i].stop()},this.delay=function(amount){return _delayTime=amount,this},this.repeat=function(times){return _repeat=times,this},this.repeatDelay=function(amount){return _repeatDelayTime=amount,this},this.yoyo=function(yoyo){return _yoyo=yoyo,this},this.easing=function(easing){return _easingFunction=easing,this},this.interpolation=function(interpolation){return _interpolationFunction=interpolation,this},this.chain=function(){return _chainedTweens=arguments,this},this.onStart=function(callback){return _onStartCallback=callback,this},this.onUpdate=function(callback){return _onUpdateCallback=callback,this},this.onComplete=function(callback){return _onCompleteCallback=callback,this},this.onStop=function(callback){return _onStopCallback=callback,this},this.update=function(time){var property,elapsed,value;if(time<_startTime)return!0;_onStartCallbackFired===!1&&(null!==_onStartCallback&&_onStartCallback.call(_object,_object),_onStartCallbackFired=!0),elapsed=(time-_startTime)/_duration,elapsed=elapsed>1?1:elapsed,value=_easingFunction(elapsed);for(property in _valuesEnd)if(void 0!==_valuesStart[property]){var start=_valuesStart[property]||0,end=_valuesEnd[property];end instanceof Array?_object[property]=_interpolationFunction(end,value):("string"==typeof end&&(end="+"===end.charAt(0)||"-"===end.charAt(0)?start+parseFloat(end,10):parseFloat(end,10)),"number"==typeof end&&(_object[property]=start+(end-start)*value))}if(null!==_onUpdateCallback&&_onUpdateCallback.call(_object,value),1===elapsed){if(_repeat>0){isFinite(_repeat)&&_repeat--;for(property in _valuesStartRepeat){if("string"==typeof _valuesEnd[property]&&(_valuesStartRepeat[property]=_valuesStartRepeat[property]+parseFloat(_valuesEnd[property],10)),_yoyo){var tmp=_valuesStartRepeat[property];_valuesStartRepeat[property]=_valuesEnd[property],_valuesEnd[property]=tmp}_valuesStart[property]=_valuesStartRepeat[property]}return _yoyo&&(_reversed=!_reversed),_startTime=void 0!==_repeatDelayTime?time+_repeatDelayTime:time+_delayTime,!0}null!==_onCompleteCallback&&_onCompleteCallback.call(_object,_object);for(var i=0,numChainedTweens=_chainedTweens.length;i<numChainedTweens;i++)_chainedTweens[i].start(_startTime+_duration);return!1}return!0}},TWEEN.Easing={Linear:{None:function(k){return k}},Quadratic:{In:function(k){return k*k},Out:function(k){return k*(2-k)},InOut:function(k){return(k*=2)<1?.5*k*k:-.5*(--k*(k-2)-1)}},Cubic:{In:function(k){return k*k*k},Out:function(k){return--k*k*k+1},InOut:function(k){return(k*=2)<1?.5*k*k*k:.5*((k-=2)*k*k+2)}},Quartic:{In:function(k){return k*k*k*k},Out:function(k){return 1- --k*k*k*k},InOut:function(k){return(k*=2)<1?.5*k*k*k*k:-.5*((k-=2)*k*k*k-2)}},Quintic:{In:function(k){return k*k*k*k*k},Out:function(k){return--k*k*k*k*k+1},InOut:function(k){return(k*=2)<1?.5*k*k*k*k*k:.5*((k-=2)*k*k*k*k+2)}},Sinusoidal:{In:function(k){return 1-Math.cos(k*Math.PI/2)},Out:function(k){return Math.sin(k*Math.PI/2)},InOut:function(k){return.5*(1-Math.cos(Math.PI*k))}},Exponential:{In:function(k){return 0===k?0:Math.pow(1024,k-1)},Out:function(k){return 1===k?1:1-Math.pow(2,-10*k)},InOut:function(k){return 0===k?0:1===k?1:(k*=2)<1?.5*Math.pow(1024,k-1):.5*(-Math.pow(2,-10*(k-1))+2)}},Circular:{In:function(k){return 1-Math.sqrt(1-k*k)},Out:function(k){return Math.sqrt(1- --k*k)},InOut:function(k){return(k*=2)<1?-.5*(Math.sqrt(1-k*k)-1):.5*(Math.sqrt(1-(k-=2)*k)+1)}},Elastic:{In:function(k){return 0===k?0:1===k?1:-Math.pow(2,10*(k-1))*Math.sin(5*(k-1.1)*Math.PI)},Out:function(k){return 0===k?0:1===k?1:Math.pow(2,-10*k)*Math.sin(5*(k-.1)*Math.PI)+1},InOut:function(k){return 0===k?0:1===k?1:(k*=2,k<1?-.5*Math.pow(2,10*(k-1))*Math.sin(5*(k-1.1)*Math.PI):.5*Math.pow(2,-10*(k-1))*Math.sin(5*(k-1.1)*Math.PI)+1)}},Back:{In:function(k){var s=1.70158;return k*k*((s+1)*k-s)},Out:function(k){var s=1.70158;return--k*k*((s+1)*k+s)+1},InOut:function(k){var s=2.5949095;return(k*=2)<1?.5*(k*k*((s+1)*k-s)):.5*((k-=2)*k*((s+1)*k+s)+2)}},Bounce:{In:function(k){return 1-TWEEN.Easing.Bounce.Out(1-k)},Out:function(k){return k<1/2.75?7.5625*k*k:k<2/2.75?7.5625*(k-=1.5/2.75)*k+.75:k<2.5/2.75?7.5625*(k-=2.25/2.75)*k+.9375:7.5625*(k-=2.625/2.75)*k+.984375},InOut:function(k){return k<.5?.5*TWEEN.Easing.Bounce.In(2*k):.5*TWEEN.Easing.Bounce.Out(2*k-1)+.5}}},TWEEN.Interpolation={Linear:function(v,k){var m=v.length-1,f=m*k,i=Math.floor(f),fn=TWEEN.Interpolation.Utils.Linear;return k<0?fn(v[0],v[1],f):k>1?fn(v[m],v[m-1],m-f):fn(v[i],v[i+1>m?m:i+1],f-i)},Bezier:function(v,k){for(var b=0,n=v.length-1,pw=Math.pow,bn=TWEEN.Interpolation.Utils.Bernstein,i=0;i<=n;i++)b+=pw(1-k,n-i)*pw(k,i)*v[i]*bn(n,i);return b},CatmullRom:function(v,k){var m=v.length-1,f=m*k,i=Math.floor(f),fn=TWEEN.Interpolation.Utils.CatmullRom;return v[0]===v[m]?(k<0&&(i=Math.floor(f=m*(1+k))),fn(v[(i-1+m)%m],v[i],v[(i+1)%m],v[(i+2)%m],f-i)):k<0?v[0]-(fn(v[0],v[0],v[1],v[1],-f)-v[0]):k>1?v[m]-(fn(v[m],v[m],v[m-1],v[m-1],f-m)-v[m]):fn(v[i?i-1:0],v[i],v[m<i+1?m:i+1],v[m<i+2?m:i+2],f-i)},Utils:{Linear:function(p0,p1,t){return(p1-p0)*t+p0},Bernstein:function(n,i){var fc=TWEEN.Interpolation.Utils.Factorial;return fc(n)/fc(i)/fc(n-i)},Factorial:function(){var a=[1];return function(n){var s=1;if(a[n])return a[n];for(var i=n;i>1;i--)s*=i;return a[n]=s,s}}(),CatmullRom:function(p0,p1,p2,p3,t){var v0=.5*(p2-p0),v1=.5*(p3-p1),t2=t*t,t3=t*t2;return(2*p1-2*p2+v0+v1)*t3+(-3*p1+3*p2-2*v0-v1)*t2+v0*t+p1}}},Gamestack.TWEEN=TWEEN,function(root){"function"==typeof define&&define.amd?define([],function(){return Gamestack}):"undefined"!=typeof module&&"object"===("undefined"==typeof exports?"undefined":_typeof(exports))?module.exports=Gamestack:void 0!==root&&(root.Gamestack=Gamestack)}(void 0);