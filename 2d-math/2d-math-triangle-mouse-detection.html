<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>2D-Math: Triangle Mouse Detection</title>
  <script src="../dist/gamelab/gamelab.js"></script>
  <script src="./js/stats/gl-example-stats.js"></script>
  <script src="./js/libs/dat.gui.js"></script>
  <script src="./js/sprites/MouseActionSprite.js"></script>
  <!-- spritebox-example.css style -->
  <link rel="stylesheet" href="./styles/example.css">

  <style>
    button#rotate {
      position: absolute;
      bottom: 11px;
      left: 20px;
      width: 140px;
      height: 32px;
      padding: 5px;
      font-size: 14px;
    }
  </style>

</head>

<body>
  <header>
    <img src="./images/lib/gamelab-logo.png" alt="" id="logo">
    <span class="title">2D-Math: Triangle Mouse Detection</span>
  </header>

  <button id="rotate" class="mode rotate">Rotate +15 degrees</button>

  <script>

    let gameWindow = new Gamelab.GameWindow().Background('black');

    let Module = Gamelab.Module;

    //control stat-display
    new Module().load('./stats/gl-example-stats.js');

    //sword sprite
    let sprite = new Gamelab.Sprite('./images/spaceship/batwing.png');

    sprite.onLoad(function(){
      //set origin/center of rotation
      sprite.origin = sprite.size.div(2);

      sprite.Origin(sprite.origin);
    });


    //mouse having position of vector
    let mouse = {
      position: new Gamelab.Vector(0, 0)
    };

    //pointSprites: array for highlighting hovered object
    let pointSprites = [];

    //populate pointSprites
    for (let x = 0; x < 6; x++) {
      pointSprites.push(new Gamelab.Sprite('./images/selection/point.png'));
      pointSprites[pointSprites.length - 1].onLoad(function() {

        this.origin = this.size.div(2);
      });

      //add to gameWindow
      gameWindow.add(pointSprites[pointSprites.length - 1]);
    }

    sprite.position.x = 300;
    sprite.position.y = 60;

    //declare MouseActionSprite for detecting hover
    new MouseActionSprite(sprite);

    //mousemove / set mouse position
    gameWindow.canvas.addEventListener('mousemove', function(evt) {
      console.info('hover::', evt);
      let rect = gameWindow.canvas.getBoundingClientRect(),
        position = {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
      mouse.position = position;
    });

    function Triangle(a, b, c)
    {
      return {
        a:a,
        b:b,
        c:c,
        draw:function(){
          Gamelab.Canvas.drawLine(this.a, this.b, 'orange');
          Gamelab.Canvas.drawLine(this.b, this.c, 'orange');
          Gamelab.Canvas.drawLine(this.a, this.c, 'orange');
        }

      };
    }


    Gamelab.ready(function() {

      //start animating
      gameWindow.start();

      //rotate sprite by 15 degrees
      document.querySelector('button#rotate').onclick = function() {
        sprite.rotation.x += 5;
      };

      //call function when sprite is clicked
      sprite.onClick(gameWindow, function() {
        console.info('sprite click', sprite);
      });

      //call function on hover
      sprite.onHoverUpdate(gameWindow, function(isHovered) {
        sprite.hovered = isHovered || false;
      });

      //reference to sprite.isHovered
      sprite.getHoverState = sprite.isHovered;

      //return collisionPoints from function-call
      sprite.getHoveredCollisionPoints = function(object, gameWindow) {
        this.getHoverState(object, gameWindow);
        return this.collisionPoints;
      };

      gameWindow.ctx.imageSmoothingEnabled = true;

      gameWindow.onBeforeDraw(function() {

        //getHovered >> isHovered, sets sprite.collisionPoints
        var cPoints = sprite.getHoveredCollisionPoints(mouse, gameWindow);

        //set pointSprites[x].position to each of the collisionPoints
        if (sprite.collisionPoints) {
          console.log('--collision');
          pointSprites[0].position = cPoints[0][0].sub(pointSprites[0].size.div(2));
          pointSprites[1].position = cPoints[0][1].sub(pointSprites[0].size.div(2));
          pointSprites[2].position = cPoints[0][2].sub(pointSprites[0].size.div(2));
          pointSprites[3].position = cPoints[1][0].sub(pointSprites[0].size.div(2));
          pointSprites[4].position = cPoints[1][1].sub(pointSprites[0].size.div(2));
          pointSprites[5].position = cPoints[1][2].sub(pointSprites[0].size.div(2));
        }

        function repos(position, sprite){
          return position.add(sprite.size.div(2.0));
        };

        let psOne = pointSprites[0];


        let triangleOne = new Triangle(repos(pointSprites[0].position, psOne),
          repos(pointSprites[1].position, psOne),
          repos(pointSprites[2].position, psOne));


        let triangleTwo = new Triangle(repos(pointSprites[3].position, psOne),
          repos(pointSprites[4].position, psOne),
          repos(pointSprites[5].position, psOne));

          pointSprites[0].triangle = triangleOne;
          pointSprites[3].triangle = triangleTwo;


        pointSprites.forEach((item) => {
          if (sprite.hovered) {
            item.active = true;
            if(item.triangle)
            {
              item.triangle.draw();
            }
          } else {
            item.active = false;
          }
        });

        console.log(sprite.size.x);
        console.log(sprite.size.y);

      });



      //add to gameWindow
      gameWindow.add(sprite);


    });
  </script>

</body>

</html>
