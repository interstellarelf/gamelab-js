<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Gif Generator</title>
    <script src="../dist/gamelab/gamelab.js"></script>
    <script src="./../res/libraries/dat.gui.js"></script>
    <script src="./../res/libraries/three.js"></script>

      <script src="./../res/libraries/rest.js"></script>
    <!-- spritebox-example.css style -->
    <link rel="stylesheet" href="../res/styles/gamelab-example.css">

    <style>

      body {
        background: #222;
      }
      span.dgc-title {
        position: absolute;
        z-index: 9999;
        width: 241px;
        height: 20px;
        font-size: 12px;
        top: 0;
        overflow: visible;
        background: #111;
        color: lightgrey;
        padding-left: 4px;
        border-bottom: 1px solid #444;
      }

      button.start {

        position:fixed;

        top:12px;

        left:40%;

        font-size:1.2em;

        background:#111;
        border:1px solid grey;

        border-radius:3px;
        color:lightgrey;
      }
    </style>

  </head>
  <body>
    <header>
      <img src="../res/images/gamelab-logo.png" alt="" id="logo">
      <span class="title">Gif
      </span>
      <button class="start" onclick="Program.run();">START</button>
    </header>

    <script>



  var time = 0;

    var Program = {

      gui:false,

      run:function(){

        Program.start();

          animate();

      },

      canvas:false,

      options:{
        rotationKey:'z',
        totalRotations:1
      },

      canvasAnimations: {},

      addAnimationFrame(name, time, imageData) {
        this.canvasAnimations[name] = this.canvasAnimations[name] || {
          frames: []
        };

        console.log('img-data-LEN:' + imageData.length);

        var lastFrame = {
          name: name,
          time: time,
          imageData: imageData
        };

        this.canvasAnimations[name].frames.push(lastFrame);
        console.info(name, this.canvasAnimations[name]);

        Rest.postJSON('/save-render', function () {

          console.log('--frame sent to server');

        }, {data: lastFrame});
      },

      start:function(){
        this.gui = this.gui || new dat.GUI();

        this.gui.add(this.options, 'rotationKey', ['z', 'y']);


        logoGroup.rotation.z = 0;
        logoGroup.rotation.y = 0;

      },

      CanvasSnap: function () {

        return this.canvas.toDataURL('image/png', 1.0);

      },
    };




      //  gameWindow.start();

      var DIST = 500,
        SIZE = 200;

      var cylinderDepth = 20.0;

      var scene = new THREE.Scene();
      var camera = new THREE.PerspectiveCamera(45, 512 / 512, 1, 1000);

      var renderer = new THREE.WebGLRenderer({antialias:true});



      renderer.setSize(512, 512);
      document.body.appendChild(renderer.domElement);


      Program.canvas = renderer.domElement;

      var geometry = new THREE.CircleGeometry(SIZE, 32);

      var glowGeometry = new THREE.CircleGeometry(SIZE * 1.2, 32);

      var frontmaterial = new THREE.MeshPhongMaterial({color: 0x7777ff, shininess: 50, map: new THREE.TextureLoader().load('res/images/musical/steal-your-face-01.png')}),
        backmaterial = new THREE.MeshPhongMaterial({color: 0x7777ff, shininess: 50, map: new THREE.TextureLoader().load('res/images/musical/steal-your-face-01.png')});
      cmaterial = new THREE.MeshPhongMaterial({color: 0x7777ff, shininess: 50, map: new THREE.TextureLoader().load('res/images/musical/disc-edge.png')});

      var cgeometry = new THREE.CylinderGeometry(SIZE, SIZE, cylinderDepth, 32),

        cylinder = new THREE.Mesh(cgeometry, cmaterial);
      cylinder.position.z = 0.1;
      cylinder.rotation.x = Math.PI / 2.0;

      backmaterial.side = THREE.DoubleSide;
      frontmaterial.side = THREE.DoubleSide;

      backmaterial.needsUpdate = true;

      var frontSide = new THREE.Mesh(geometry, frontmaterial);
      var backSide = new THREE.Mesh(geometry, backmaterial);

      var logoGroup = new THREE.Group();

      backSide.position.z = -(cylinderDepth / 2.0);
      frontSide.position.z = (cylinderDepth / 2.0) + (cylinderDepth / 5.0);

      logoGroup.add(frontSide);
      logoGroup.add(backSide);

      logoGroup.add(cylinder);

      scene.add(logoGroup);

      logoGroup.position.z = -DIST;

      var done = false;


      var countRotations = 0, frameIndex = 0;

      logoGroup.spin = function (speed) {

        var inc = Math.PI * 2 / 360,
        key = Program.options.rotationKey;

        speed = speed - (speed % inc);

        console.log(speed);

        this.rotation[key] += speed;



        frameIndex += 1;

        var three_sixty = Math.PI * 2.0;
        var diff = three_sixty % speed;

        if(this.rotation[key] >= three_sixty)
        {
          this.rotation[key] = 0;
          countRotations += 1;

          alert('full rotation');

        }

        if(!done){

                  Program.addAnimationFrame('anime', frameIndex, Program.CanvasSnap());

        }

        if(countRotations >= 1)
        {
            done = true;
        }

      };

      var ambientLight = new THREE.AmbientLight(0xFFFFFF);

      scene.add(ambientLight);

      camera.position.z = 150;



      function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
        logoGroup.spin(0.05);

      }
    </script>

  </body>
</html>
