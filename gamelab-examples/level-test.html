<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Sprite Demo</title>
    <script src="../dist/gamelab/gamelab.js"></script>
    <script src="../dist/domfx/domfx.js"></script>

    <script src="./res/html/gui-helpers.js"></script>

    <script src="./res/html/menu/html.power-meter.js"></script>

    <!-- spritebox-example.css style -->
    <link rel="stylesheet" href="../res/styles/gamelab-example.css">

    <style>

      #menu-fx canvas,
      #menu-shots canvas {
        position: relative;
        cursor: pointer;
        background: rgba(0, 0, 0, 0.2);
      }
      #menu-fx .zoomwrap,
      #menu-shots .zoomwrap {
        display: block;
        /* change the default display type to inline-block */
        overflow: hidden;
        /* hide the overflow */
      }
      #menu-fx canvas.selected,
      #menu-shots canvas.selected {
        zoom: 1.0;
        background: url("./../../res/images/effects/effect-selected.png");
        background-size: 100% auto;
      }
      div.menu-space h4 {
        font-size: 1.2em;
        color: lightgrey;
      }
      span#console {
        font-size: 1.1em;
        color: grey;
        position: fixed;
        font-family: monospace;
        font-weight: lighter;
        z-index: 9999;
        width: 30%;
        bottom: 4px;
        right: 30px;
        min-height: 30px;
        border: 1px solid grey;
        background: #111;
        text-align: left;
      }
      img#pause {
        position: fixed;
        z-index: 9999;
        width: 60px;
        height: auto;
        top: 30%;
        left: 50%;
        margin-left: -30px;
        display: none;
        opacity: 0.8;
        padding: 4px;
        border-radius: 7px;
        background: rgba(25, 25, 25, 0.9);
        border: 2px ridge #333;
      }
    </style>

  </head>
  <body>
    <header>
      <img src="../res/images/gamelab-logo.png" alt="" id="logo">
      <span class="title">Sprite Demo</span>

    </header>

    <img alt="" id="pause" src='./res/images/menu/pause.png'>
    <power-meter></power-meter>

    <script>

      /***************
      * Call gameWindow.start()
      * *************/

      var Vector = Gamelab.Vector;

      var player = new Gamelab.Sprite('res/images/sprites/super-ghouls-and-ghosts-green-arthur.png');

      var pauseClock = new Gamelab.FiringClock();

      pauseClock.Duration(100000000).Every(10);


      /************************************
      *
      * GameDemo {}
      *  -handles the pause event
      *  -stops and starts gameplay using pauseClock
      *
      *************************************/

      var GameDemo = {

        isPaused: function () {
          return this.paused;
        },

        paused: false,

        Pause: function () {

          var $controller = this;

          pauseClock.fire(function () {

            $controller.paused = !$controller.paused;
            var pause_image = document.querySelector('img#pause');

            if ($controller.isPaused()) {
              pause_image.style.display = 'block';
            } else {
              pause_image.style.display = 'none';
            }

            gameWindow.setPause($controller.paused);

          });

        }
      };



            /************************************
            *
            * Xbox_buttons {}
            *  -holds the current value of gamepad inputs
            *
            *************************************/

      var Xbox_buttons = {
        x: 0,
        a: 0,
        b: 0,
        y: 0
      };


            /************************************
            *
            * GameLevel {}
            *  -holds the arrays of sprites --game content
            *
            *************************************/

      var GameLevel = {

        terrains: [],
        water: [],
        tiles: [],
        drawCanvases: []

      };


      /************************************
      * Load Terrains
      *************************************/

      new Gamelab.Code().loadAndRun('./res/scripts/squid-fight/squid-fight.terrains.js', function (objects) {

        //alert('code loaded');

        GameLevel.terrains = objects.terrains;
        GameLevel.waterTop = objects.waterTop;

        GameLevel.waterTiles = objects.waterTiles;

        GameLevel.tiles = objects.tiles;

        setTimeout(function () {

        //  alert('drawing tiles');

        var WIDTH =GameLevel.tiles[0].size.x, HEIGHT = GameLevel.tiles[0].size.y;

          for (var x = 0; x <= GameLevel.tiles.maxX().x; x += WIDTH * 50) {
            for (var y = 0; y <= GameLevel.tiles.maxY().y; y += HEIGHT * 50) {
              var tileCanvas = document.createElement('canvas');

              tileCanvas.width = WIDTH * 50 + WIDTH;
              tileCanvas.height = HEIGHT * 50 + HEIGHT;

              var tileCtx = tileCanvas.getContext('2d');

              GameLevel.tiles.forEach(function (t) {

                t.invisible = false;

                t.DRAWOFFSCREEN = true;

                if (t.position.x >= x && t.position.x <= x + (WIDTH * 50) && t.position.y >= y && t.position.y <= y + (HEIGHT * 50)) {
                  t.draw(tileCtx, {
                    position: new Gamelab.Vector(x, y)
                  });
                }

                t.DRAWOFFSCREEN = false;

                t.invisible = true;

              });

              tileCanvas.position = new Gamelab.Vector(x, y);

              GameLevel.drawCanvases.push({canvas: tileCanvas, ctx: tileCtx});

            }
          }

        }, 4000);

        /************************************
        * Load Water
        *************************************/

        setTimeout(function () {

          new Gamelab.Module().load('./res/scripts/game-elements/water.behavior.js', function (construct) {

          //  alert('water loaded');

          //  alert(GameLevel.waterTiles.length);

            var water = new construct(GameLevel.waterTiles, gameWindow);

            GameLevel.waters = GameLevel.waters || [];

            GameLevel.waters.push(water);

          });

        }, 2000);

      });


      /************************************
      * Player Load
      *************************************/

      player.onLoad(function () {

        this.Animation(PlayerAnimations.run);
        this.Size(this.anime.size.mult(1.4));
        this.Position(200, 350);

      });

      var timer = 0;


      /************************************
      * Player: Extend update(){} w/ onUpdate(fxn)
      *************************************/

      player.onUpdate(function () {

        this.anime.animate();

      });

      /************************************
      * Player: runForward fxn
      *************************************/

      player.runForward = function (speed, flipX) {

        if (this.jumping || this.double_jumping) {
          return;
        }

        this.flipX = flipX;

        var doAnime = false;

        if (speed >= 0 && speed < 2.0 && !flipX)
          speed = 2.0;

        if (speed <= 0 && speed > -2.0 && flipX)
          speed = -2.0;

        this.speed = new Gamelab.Vector(
          speed > 0
            ? speed - (speed % 5.0)
            : speed + (-speed % 5.0),
          this.speed.y
        );

        //  console.log(this.speed.x);

        if (!this.speed_update) {

          this.speed_update = function () {
            this.position = this.position.add(this.speed);
          };

          this.def_update = function () {
            this.speed_update();
          };

        }

        if ([PlayerAnimations.run, PlayerAnimations.jump, PlayerAnimations.throw, PlayerAnimations.double_jump].indexOf(this.anime) == -1)
          doAnime = true;

        if (doAnime) {
          this.Animation(PlayerAnimations.run.Duration(400));
          this.Size(this.anime.size.mult(1.4));
        }

      };



            /************************************
            * Player: doIdle fxn
            *************************************/

      player.doIdle = function () {

        if (this.nextEvent == 'idle' && this.anime !== PlayerAnimations.idle) {
          this.Animation(PlayerAnimations.idle);
          this.Size(this.anime.size.mult(1.4));
        }

        if (this.nextEvent == 'idle')
          this.decelX(0.6);
        };


        /************************************
        * Player: crouch fxn
        *************************************/

      player.crouch = function () {

        if (Xbox_buttons.b) {
          this.crouch_throw();
          this.decelX(0.6);
          return;
        }

        if ((this.nextEvent == 'crouch' || this.nextEvent == 'crouch_throw_to_crouch') && this.anime !== PlayerAnimations.crouch_idle) {
          this.Animation(PlayerAnimations.crouch_idle.Duration(500));
          this.Size(this.anime.size.mult(1.4));
        }

        if (this.nextEvent == 'crouch')
          this.decelX(0.6);
        };

      player.crouch_throw = function () {

        var __player = this;

        if (this.anime !== PlayerAnimations.crouch_throw) {
          this.Animation(PlayerAnimations.crouch_throw.Duration(250));

          this.Size(this.anime.size.mult(1.4));

          PlayerAnimations.crouch_throw.soleComplete(function () {
            __player.nextEvent = 'crouch_throw_to_crouch';
            __player.crouch();

            //console.log('animation complete::' + this.complete_ext.length);

          });
          this.Size(this.anime.size.mult(1.4));
        }

        this.decelX(0.6);
      };

      player.jumpTimer = 0;


      /************************************
      * Player: jump_straight fxn
      *************************************/

      player.jump_straight = function (accel = 1.0) {

        if (this.jumpTimer < 0)
          this.jumping = false;

        if (this.jumping && this.jumpTimer >= 0) {
          this.nextEvent = 'jump';

          this.speed.y = this.speed.y > -6
            ? -6
            : this.speed.y;

          this.speed.y -= accel;

          this.jumpTimer -= 1;
        }

        if (this.anime !== PlayerAnimations.jump_straight) {
          this.Animation(PlayerAnimations.jump_straight);

          this.Size(PlayerAnimations.jump_straight.size.mult(1.3));

          PlayerAnimations.jump_straight.soleComplete(function () {});

        }

      };

      /************************************
      * Player: jump_double fxn
      *************************************/

      player.jump_double = function (accel = 1.0) {

        this.doubleJumpDone = true;

        if (this.jumpTimer < 0)
          this.double_jumping = false;

        if (this.double_jumping && this.jumpTimer >= 0) {
          this.nextEvent = 'double-jump';

          this.speed.y = this.speed.y > -6
            ? -6
            : this.speed.y;

          this.speed.y -= accel;

          this.jumpTimer -= 1;
        }

        if (this.anime !== PlayerAnimations.double_jump) {
          this.Animation(PlayerAnimations.double_jump);

          this.Size(this.anime.size.mult(1.3));

          PlayerAnimations.double_jump.soleComplete(function () {});

        }

      };


      /************************************
      * Player: throw fxn
      *************************************/

      player.throw = function () {
        var _p = this;
        if (this.anime !== PlayerAnimations.throw) {

          this.nextEvent = 'throw';
          this.Animation(PlayerAnimations.throw);

          this.Size(PlayerAnimations.throw.size.mult(1.4));

          PlayerAnimations.throw.soleComplete(function () {

            //alert('throw complete --in air?' + _p.__inAir);

            _p.throw_weapon();

            if (Xbox_buttons.b == 0 || Xbox_buttons.b >= BUTTONTIME) {
              _p.nextEvent = 'idle';
              _p.doIdle();
            }

            //console.log('animation complete::' + this.complete_ext.length);
          });

          this.Size(this.anime.size.mult(1.4));

        }

      };

      var BUTTONTIME = 40;

      var gravity = new Gamelab.Gravity();


      /************************************
      * PlayerAnimations
      *************************************/

      var PlayerAnimations = {

        idle: new Gamelab.Animation('res/images/sprites/super-ghouls-and-ghosts-green-arthur.png').FrameSize(30, 45).FrameBounds(new Vector(0, 0), new Vector(0, 0), new Vector(0, 0)).Size(30, 45).Duration(Infinity),

        crouch_idle: new Gamelab.Animation('res/images/sprites/super-ghouls-and-ghosts-green-arthur.png').FrameSize(35, 45).FrameBounds(new Vector(0, 2), new Vector(0, 2), new Vector(0, 2)).Size(35, 45).Duration(200),

        run: new Gamelab.Animation('res/images/sprites/super-ghouls-and-ghosts-green-arthur.png').FrameSize(30, 45).FrameBounds(new Vector(1, 0), new Vector(6, 0), new Vector(6, 0)).Size(30, 45).Duration(500),

        throw: new Gamelab.Animation('res/images/sprites/super-ghouls-and-ghosts-green-arthur.png').FrameSize(35, 45).FrameBounds(new Vector(0, 1), new Vector(1, 1), new Vector(1, 1)).Size(35, 45).Duration(200),

        crouch_throw: new Gamelab.Animation('res/images/sprites/super-ghouls-and-ghosts-green-arthur.png').FrameSize(35, 45).FrameBounds(new Vector(0, 2), new Vector(2, 2), new Vector(2, 2)).Size(35, 45).Duration(200),

        jump_straight: new Gamelab.Animation('res/images/sprites/super-ghouls-and-ghosts-green-arthur.png').FrameSize(30, 45).FrameBounds(new Vector(0, 4), new Vector(0, 4), new Vector(0, 4)).Size(35, 45).Duration(200),

        double_jump: new Gamelab.Animation('res/images/sprites/super-ghouls-and-ghosts-green-arthur.png').FrameSize(35, 45).FrameBounds(new Vector(1, 4), new Vector(1, 4), new Vector(1, 4)).Size(35, 45).Duration(200),

        jump_forward: new Gamelab.Animation('res/images/sprites/super-ghouls-and-ghosts-green-arthur.png').FrameSize(35, 45).FrameBounds(new Vector(1, 4), new Vector(1, 4), new Vector(1, 4)).Size(35, 45).Duration(200),

        fall: new Gamelab.Animation('res/images/sprites/super-ghouls-and-ghosts-green-arthur.png').FrameSize(30, 45).FrameBounds(new Vector(0, 4), new Vector(0, 4), new Vector(0, 4)).Size(35, 45).Duration(Infinity)

      };

      PlayerAnimations.jump_straight.Duration(350)

      PlayerAnimations.double_jump.Duration(950)

      PlayerAnimations.throw.soleComplete(function () {});

      /************************************
      * Player: soleComplete(fxn) defines the code to run when
      * 'crouch_throw' animation is complete
      *************************************/

      PlayerAnimations.crouch_throw.soleComplete(function () {

        player.Animation(PlayerAnimations.crouch_idle);
        player.Size(PlayerAnimations.crouch_idle.size.mult(1.4));

      });

      PlayerAnimations.jump_straight.soleComplete(function () {});



      /************************************
      * Declare gameWindow
      *************************************/

      var gameWindow = new Gamelab.GameWindow().Background('#111');

      //Shoot / Throw:

      /************************************
      * weapon --arguments
      *************************************/

      var fireringargs = {

        sourcelists: {
          a: [],
          b: [],
          c: [],
          d: [],
          e: []
        },

        shape: 'circle',

        path: {
          selection: 'random',
          size: {
            x: 200,
            y: 200
          },
          curve: 'linear'
        },

        birthrate: {
          a: 20,
          b: 20,
          transition: 'random'
        },

        life: {
          a: 90,
          b: 90,
          transition: 'random'
        },

        color: {
          a: '#ff00ff',
          b: '#aa00aa',
          transition: 'linear'
        },

        speed: {
          a: 8,
          b: 14,
          transition: 'linear'
        },
        scale: {
          a: 0.4,
          b: 1.4,
          transition: 'linear'
        },
        angle: {
          a: -105,
          b: -65,
          transition: 'random'
        },
        alpha: {
          a: 1.0,
          b: 0.1,
          transition: 'linear'
        }
      };


      /************************************
      * weapons{} --object
      *************************************/

      player.weapons = {
        firering: new Gamelab.Particle(fireringargs, gameWindow).Src('./res/images/particles/white-ring.png')
      };

      console.info(player.weapons.firering);

      //many instances of sound

      player.weapons.firering.sound = new Gamelab.SoundList([
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3',
        './res/sounds/shot.mp3'
      ]).Volume(0.3);


            /************************************
            * throw_weapon --fxn
            *************************************/

      player.throw_weapon = function () {

        //console.log('throw_weapon');

        this.guns = this.weapons;

        if (this.ticker % 10 == 0) {
          this.guns.firering.sound.play();
        }

        if (this.flipX) {
          this.guns.firering.Angle(180, 180, 'random');
          this.guns.firering.Pos(this.position);
          this.guns.firering.enter(1);
        } else {
          this.guns.firering.Angle(0, 0, 'random');
          this.guns.firering.Pos(this.position);
          this.guns.firering.enter(1);
        }

      };


      /************************************
      * collide_stop_all :: player-collisions
      *************************************/

      player.collide_stop_all = function () {

        var collideables = GameLevel.terrains,
          clist = collideables;

        var playersIndex = 0;

        var $P = this,
          min = new Gamelab.Vector($P.position.sub(2000, 2000)),
          max = new Gamelab.Vector($P.position.add(2000, 2000));

        for (var x = 0; x < clist.length; x++) {
          var c = clist[x];
          if (c.position.x >= min.x && c.position.x <= max.x && c.position.y >= min.y && c.position.y <= max.y) {
            player.collide_stop(clist[x]);
            if (player.overlap_x(clist[x]) && player.overlap_y(clist[x]) && !player.jumping) {
              //console.log('OVERLAP');
              player.__inAir = false;

              if (player.doubleJumpDone)
                player.doubleJumpDone = false;

              if (player.anime == PlayerAnimations.jump_straight || player.anime == PlayerAnimations.double_jump) {
                player.nextEvent = 'idle';
                player.doIdle();
              }

            }
          }
        }

      };

      var camera = gameWindow.camera;



      gameWindow.onAfterDraw(function () {

        if (GameLevel.drawCanvases instanceof Array) {
          //    console.log('drawing ctx');
          GameLevel.drawCanvases.forEach(function (obj) {

            gameWindow.ctx.drawImage(obj.canvas, obj.canvas.position.x - camera.position.x, obj.canvas.position.y - camera.position.y, obj.canvas.width, obj.canvas.height);

          });
        }

      });


      /************************************
      * single fxn before draw() call of gameWindow
      *************************************/

      gameWindow.onBeforeDraw(function () {

        gravity.pull(player, 0.5, 8.0);

        player.__inAir = true;

        player.collide_stop_all();

        if (player.double_jumping) {
          player.jumping = false;
          player.jump_double();
        } else if (player.jumping) {
          player.jump_straight(); //console.log(player.__inAir););
        } else if (player.__inAir && [PlayerAnimations.fall, PlayerAnimations.throw, PlayerAnimations.run, PlayerAnimations.jump_straight, PlayerAnimations.double_jump].indexOf(player.anime) == -1) {
          player.nextEvent = 'fall';
          player.Anime(PlayerAnimations.fall);
          player.Size(PlayerAnimations.fall.size.mult(1.3));
        }

        var pos = player.position.sub(camera.position);

        while (pos.x > gameWindow.canvas.width * 0.60) {
          pos.x = player.position.x - camera.position.x;
          camera.position.x += 1.0;
        }

        while (pos.x < gameWindow.canvas.width * 0.40) {
          pos.x = player.position.x - camera.position.x;
          camera.position.x -= 1.0;
        }

        while (pos.y > gameWindow.canvas.height * 0.55) {
          pos.y = player.position.y - camera.position.y;
          camera.position.y += 1.0;
        }

        while (pos.y < gameWindow.canvas.height * 0.15) {
          pos.y = player.position.y - camera.position.y;
          camera.position.y -= 1.0;
        }

      });

      new Gamelab.Code().loadAndRun('./res/scripts/squid-fight/squid-fight.backgrounds.js', function (objects) {});

      function onButton(selector, callback) {

        var btn = document.querySelector(selector);

        btn.onclick = function () {

          if (callback)
            callback();
          };
      };

      Gamelab.ready(function () {

        /************************************
        * player has power meter
        *************************************/

        var powerMeter = document.querySelector('power-meter');

        powerMeter.Fill();


        /************************************
        * gamepad controls
        *************************************/

        new Gamelab.Code().loadAndRun('./res/scripts/squid-fight/player.controls.js', function (objects) {});

        //alert('gamelab ready');

        gameWindow.add(player);

        console.info(player);

        gameWindow.start();

      });
    </script>

  </body>
</html>
